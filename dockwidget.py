# -*- coding: utf-8 -*-
"""
/***************************************************************************
 xml_uaDockWidget
                                 A QGIS plugin
 Processing ukrainian cadastral files.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2024-11-01
        git sha              : $Format:%H$
        copyright            : (C) 2024 by Mike
        email                : michael.krechkivski@gmail.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os
import inspect
import copy

from lxml import etree

from qgis.PyQt import uic

from qgis.PyQt.QtGui import QIcon

from qgis.PyQt.QtCore import QModelIndex
from qgis.PyQt.QtCore import pyqtSignal
from qgis.PyQt.QtCore import Qt

from qgis.core import Qgis
from qgis.core import QgsLayerTreeGroup
from qgis.core import QgsProject

from qgis.PyQt.QtWidgets import QDockWidget
from qgis.PyQt.QtWidgets import QWidget
from qgis.PyQt.QtWidgets import QVBoxLayout
from qgis.PyQt.QtWidgets import QHBoxLayout
from qgis.PyQt.QtWidgets import QMenu
from qgis.PyQt.QtWidgets import QAction
from qgis.PyQt.QtWidgets import QMessageBox
from qgis.PyQt.QtWidgets import QToolButton
from qgis.PyQt.QtWidgets import QStyle
from qgis.PyQt.QtWidgets import QTreeView
from qgis.PyQt.QtWidgets import QFileDialog
from qgis.PyQt.QtWidgets import QTableView

from qgis.PyQt.QtWidgets import QTabWidget, QStyleOption, QWidget, QStyle, QPushButton, QTabBar
from qgis.PyQt.QtGui import QPainter, QIcon, QPalette
from qgis.PyQt.QtCore import QSettings

from .tree_view import CustomTreeView
from .metadata import TableViewMetadata
from .parcel import TableViewParcel
from .layers import xmlUaLayers

from .common import logFile
from .common import log_msg
from .common import log_calls
from .common import xsd_path
from .common import connector
from .common import geometry_to_string


FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'xml_ua_dockwidget_base.ui'))


class xml_uaDockWidget(QDockWidget, FORM_CLASS):

    closingPlugin = pyqtSignal()

    def __init__(self, parent=None, plugin=None):

        # —Ç–∏–ø parent QMainWindow
        # –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ª–∏—à–µ –ø—ñ—Å–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–∞–π–ª–∞

        # log_calls(logFile, f"\nparent: {parent}\nplugin: {plugin}")

        super().__init__(parent)

        self.iface = plugin.iface  # add iface to class

        connector.connect(self.iface.layerTreeView(), "doubleClicked", self.double_clicked)
        connector.connect(self.iface.layerTreeView(), "clicked", self.clicked)

        self.plugin = plugin
        # –ß–∏—Ç–∞—î–º–æ –¥–∏–∑–∞–π–Ω UI –∑ —Ñ–∞–π–ª—É xml_ua_dockwidget_base.ui
        self.setupUi(self)
        self.parent = parent

        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø—É—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫ –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö xml-—Ñ–∞–π–ª—ñ–≤
        self.opened_xmls = []

        # —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
        self.full_xml_file_name = None
        # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–∂–µ—Ç–∞ –∑ —Ä–µ—î—Å—Ç—Ä—É Windows
        self.closed_tabs = []
        # ?
        self.layers_obj = None
        self.full_xml_file_name = ""
        self.tabWidget.setTabsClosable(True)

        # –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö xml-—Ñ–∞–π–ª—ñ–≤
        # –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä–µ–Ω–µ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–µ—Ä–µ–≤–∞ —à–∞—Ä—ñ–≤ QGIS
        self.layers_root = QgsProject.instance().layerTreeRoot()

        old_tree_view = self.findChild(QTreeView, "treeViewXML")
        self.treeViewXML = CustomTreeView(parent=self)
        if old_tree_view:
            layout = self.tabXML.layout()
            if layout:
                layout.removeWidget(old_tree_view)
            old_tree_view.setParent(None)
            old_tree_view.deleteLater()
        self.treeViewXML.setObjectName("treeViewXML")
        self.tabXML.layout().addWidget(self.treeViewXML)

        old_table_view = self.findChild(QTableView, "tableViewMetadata")
        if old_table_view:
            layout = self.tabMetadata.layout()
            if layout:
                layout.removeWidget(old_table_view)
            old_table_view.setParent(None)
            old_table_view.deleteLater()
        self.tableViewMetadata = TableViewMetadata(parent=self)  # ‚úÖ
        self.tableViewMetadata.setObjectName(
            "tableViewMetadata")  # –ó–∞–ª–∏—à–∞—î–º–æ —Ç–µ —Å–∞–º–µ —ñ–º'—è
        self.tableViewMetadata.horizontalHeader().setStretchLastSection(True)
        self.tabMetadata.layout().addWidget(self.tableViewMetadata)  # –î–æ–¥–∞—î–º–æ –¥–æ layout

        old_parcel_view = self.findChild(QTableView, "tableViewParcel")
        if old_parcel_view:
            layout = self.tabParcel.layout()
            if layout:
                layout.removeWidget(old_table_view)
                layout.removeWidget(old_parcel_view)
            old_parcel_view.setParent(None)
            old_parcel_view.deleteLater()
        self.tableViewParcel = TableViewParcel(parent=self)
        self.tableViewParcel.setObjectName("tableViewParcel")
        self.tableViewParcel.horizontalHeader().setStretchLastSection(True)
        self.tabParcel.layout().addWidget(self.tableViewParcel)

        self.setWindowTitle("XML-—Ñ–∞–π–ª –æ–±–º—ñ–Ω—É –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é")
        # –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –¥–∞–Ω–∏—Ö xml, —è–∫–∏–π –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —É –¥–æ–∫–≤—ñ–¥–∂–µ—Ç—ñ
        self.current_xml = self.xml_data(path="", tree=None, group_name=None)

        self.setup_custom_tab_buttons() # <- –ø–µ—Ä–µ–Ω–µ—Å–µ–º–æ —Å—é–¥–∏, –ø—ñ—Å–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≤—ñ–¥–∂–µ—Ç—ñ–≤
        connector.connect(self.tabWidget, "tabCloseRequested", self.close_tab) # <- —Ç—É—Ç –±—É–¥–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—à–µ


    class xml_data:
        def __init__(self, path: str = "", tree: object = None, group_name: str = ""):  # –ó–º—ñ–Ω–µ–Ω–æ
            self.path = path
            self.tree = tree
            self.group_name = group_name  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —ñ–º'—è –≥—Ä—É–ø–∏
            self.changed = False

        def __deepcopy__(self, memo):
            """
            Deep copy implementation for xml_data objects.
            """
            cls = self.__class__
            result = cls.__new__(cls)
            memo[id(self)] = result
            for k, v in self.__dict__.items():
                if k == "tree":
                    setattr(result, k, copy.deepcopy(v, memo))
                else:
                    setattr(result, k, copy.deepcopy(v, memo))
            return result

    def tab_button_clicked(self, index):
        """
        This method will be called when a tab's close button is clicked.
        """
        self.tabWidget.tabCloseRequested.emit(index)

    def setup_custom_tab_buttons(self):
        """
        –ù–∞–ª–∞—à—Ç–æ–≤—É—î –∫–∞—Å—Ç–æ–º–Ω—ñ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è –≤–∫–ª–∞–¥–æ–∫.
        """
        opt = QStyleOption()
        opt.initFrom(self)
        close_icon = self.style().standardIcon(QStyle.SP_TitleBarCloseButton, opt)

        # log_calls(logFile, "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω—è –∫–∞—Å—Ç–æ–º–Ω–∏—Ö –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä–∏—Ç—Ç—è –≤–∫–ª–∞–¥–æ–∫")


        tab_bar = self.tabWidget.tabBar()  # Move tab_bar here
        for i in range(self.tabWidget.count()):

            tab_name = self.tabWidget.tabText(i)
            # –ù–µ –¥–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä–∏—Ç—Ç—è –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
            if tab_name not in ["–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"]:
                tab_button = QPushButton(close_icon, "")
                tab_button.setObjectName(f"tab_close_button_{i}")
                # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ —Ä–æ–∑–º—ñ—Ä—É —ñ–∫–æ–Ω–∫–∏
                tab_button.setFixedSize(close_icon.actualSize(
                    close_icon.availableSizes()[0]))
                tab_button.setStyleSheet("""
                    QPushButton {
                        border: none;
                        background-color: transparent;
                        padding: 0px;
                    }
                    QPushButton:hover {
                        background-color: lightgray;
                    }
                    QPushButton:pressed {
                        background-color: gray;
                    }
                """)
                tab_bar.setTabButton(i, QTabBar.RightSide, tab_button)
                #log_msg(logFile, f"–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä–∏—Ç—Ç—è –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ {i}")
                # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è, —è–∫—â–æ —Ç–∞–∫—ñ —î
                try:
                    connector.disconnect(tab_button, "clicked", self.tab_button_clicked)
                except TypeError:
                    pass  # –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ –∑'—î–¥–Ω–∞–Ω—å –Ω–µ –±—É–ª–æ
                # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–µ –∑'—î–¥–Ω–∞–Ω–Ω—è
                connector.connect(tab_button, "clicked", lambda _, idx=i: self.tab_button_clicked(idx))

            else:
                # remove margin for static tabs
                tab_bar.setTabButton(i, QTabBar.RightSide, None)
                tab_bar.setTabButton(i, QTabBar.LeftSide, None)

        # log_msg(logFile, "–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤–∫–ª–∞–¥–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n---")


        self.tabWidget.setStyleSheet("""
            QTabWidget::tab-bar {
                alignment: left;
            }
            QTabBar::close-button {
                image: none; /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
                subcontrol-position: right;
            }
            QTabBar::tab {
                padding: 5px;
            }
            QTabBar::tab:selected {
                /*margin-right: 0px;*/ /* Remove for all selected */
            }
            QTabBar::tab:!selected {
                /*margin-right: 0px; */ /* Remove for all not selected */
            }
             QTabBar::tab:!selected {
                margin-right: 0px; /* remove margin for all unselected */
            }
            QTabBar::tab:selected {
                margin-right: 0px; /* remove margin for all selected */
            }

            /* Special rules for static tabs (no close button) */
            QTabBar::tab:nth-child(1), /* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ */
            QTabBar::tab:nth-child(2), /* –ú–µ—Ç–∞–¥–∞–Ω—ñ */
            QTabBar::tab:nth-child(3) { /* –î—ñ–ª—è–Ω–∫–∞ */
                margin-right: 0px; /* No margin for static tabs */
            }
        """)
        return



    def add_tab(self, tab_name, widget):
        """
        –î–æ–¥–∞—î –≤–∫–ª–∞–¥–∫—É –∑ –ø–µ–≤–Ω–∏–º —ñ–º'—è–º —ñ –≤—ñ–¥–∂–µ—Ç–æ–º.

        References:
            update_restore_tabs_action
            restore_tabs
        Args:
            tab_name (str): –Ü–º'—è –≤–∫–ª–∞–¥–∫–∏.
            widget (QWidget,self.tabXML,self.tabMetadata,
                self.tabParcel) 
                –í—ñ–¥–∂–µ—Ç, —è–∫–∏–π –±—É–¥–µ —Ä–æ–∑–º—ñ—â–µ–Ω–∏–π 
                –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ.
        """
        log_msg(logFile, tab_name)
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∫–ª–∞–¥–∫–∞ –≤–∂–µ —ñ—Å–Ω—É—î
        for i in range(self.tabWidget.count()):
            if self.tabWidget.tabText(i) == tab_name:
                return  # –í–∫–ª–∞–¥–∫–∞ –≤–∂–µ —ñ—Å–Ω—É—î, –≤–∏—Ö–æ–¥–∏–º–æ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó

        if tab_name == "–°—Ç—Ä—É–∫—Ç—É—Ä–∞":
            layout = QVBoxLayout()
            layout.addWidget(self.treeViewXML)
            self.tabXML.setLayout(layout)
        elif tab_name == "–ú–µ—Ç–∞–¥–∞–Ω—ñ":
            layout = QVBoxLayout()
            layout.addWidget(self.tableViewMetadata)
            self.tabMetadata.setLayout(layout)
        elif tab_name == "–î—ñ–ª—è–Ω–∫–∞":
            layout = QVBoxLayout()
            layout.addWidget(self.tableViewParcel)
            self.tabParcel.setLayout(layout)

        self.setup_custom_tab_buttons()

        self.tabWidget.addTab(widget, tab_name)

        # Add tab name to opened_tabs only if it's not already there
        if tab_name not in self.opened_tabs:
            self.opened_tabs.append(tab_name)
        if tab_name in self.closed_tabs:
            self.closed_tabs.remove(tab_name)
        self.plugin.update_restore_tabs_action()



    def load_data(self, xml_path, tree = None):

        # –ü—Ä–∏ –≤–∏–∫–ª–∏–∫—É –∑ process_group_click tree != None
        # –ü—Ä–∏ –≤–∏–∫–ª–∏–∫—É –∑ process_action_open tree == None

        # log_calls(logFile, f"xml_path = {xml_path}\ntree = {tree}")

        # –∑–∞–ø–æ–≤–Ω—é—î –¥–µ—Ä–µ–≤–æ –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
        self.treeViewXML.load_xml_to_tree_view(xml_path, xsd_path, tree)

        # 2) tree
        # self.current_xml.tree = self.treeViewXML.xml_tree # –≤–∏–¥–∞–ª–µ–Ω–æ
        self.current_xml.tree = self.treeViewXML.xml_tree  # –î–æ–¥–∞–Ω–æ

        # –∑–∞–ø–æ–≤–Ω—é—î –≤–∫–ª–∞–¥–∫—É "–ú–µ—Ç–∞–¥–∞–Ω—ñ"
        # self.tableViewMetadata.fill_meta_data(self.treeViewXML.xml_tree)
        self.tableViewMetadata.fill_meta_data(self.current_xml.tree)
        # –∑–∞–ø–æ–≤–Ω—é—î –≤–∫–ª–∞–¥–∫—É "–î—ñ–ª—è–Ω–∫–∞" —Ç–∞ —ñ–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏ –∑–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ
        # self.tableViewParcel.fill_parcel_data(self.treeViewXML.xml_tree)
        self.tableViewParcel.fill_parcel_data(self.current_xml.tree)

        self.treeViewXML.model.setHorizontalHeaderLabels(
            ["–ï–ª–µ–º–µ–Ω—Ç", "–ó–Ω–∞—á–µ–Ω–Ω—è"])
        self.tableViewMetadata.model().setHorizontalHeaderLabels([
            "–ï–ª–µ–º–µ–Ω—Ç", "–ó–Ω–∞—á–µ–Ω–Ω—è"])
        self.tableViewParcel.model().setHorizontalHeaderLabels([
            "–ï–ª–µ–º–µ–Ω—Ç", "–ó–Ω–∞—á–µ–Ω–Ω—è"])

        return

    def process_action_check(self):
        """ """
        log_msg(logFile, "–û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ–∞–π–ª—É XML")

        # level= Qgis.Success, Qgis.MessageLevel, Qgis.Info, Qgis.Warning, Qgis.Critical
        # duration sec 0 - –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è
        self.parent.iface.messageBar().pushMessage(
            "xml_ua:", "–û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ–∞–π–ª—É XML", level=Qgis.Success, duration=0)
        QMessageBox.warning(self, "xml_ua:", "–í–∏—Ö—ñ–¥")
        self.handle_error_and_close("–û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ–∞–π–ª—É XML")

    def process_action_open(self):
        """
        Handles the action of opening an XML file.
        This method performs the following steps:
        1. Logs the action.
        2. Closes all tabs except "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", and "–î—ñ–ª—è–Ω–∫–∞".
        3. Clears existing data in TreeView and TableViews.
        4. Opens a file dialog to select an XML file.
        5. If no file is selected, shows a warning message and exits.
        6. Sets the window title to the selected file's name.
        7. Loads data from the selected XML file.
        8. Expands initial elements in the TreeView and sets the column width.
        9. Retrieves the layers_obj name from the XML layers and logs it.
        Returns:
            None
        """

        # log_calls(logFile)

        # –ü—ñ–¥–≥–æ—Ç–æ—á–∏–π –µ—Ç–∞–ø - –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –≤—ñ–¥–∂–µ—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö
        # –æ—á–∏—â–∞—î–º–æ –º–æ–¥–µ–ª—ñ –≤—ñ–¥–∂–µ—Ç—ñ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö, –∞ –Ω–µ –≤–∏–¥–∞–ª—è—î–º–æ —ó—Ö

        # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
        for i in reversed(range(self.tabWidget.count())):
            # —Ü–∏–∫–ª –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏ —É –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É
            tab_name = self.tabWidget.tabText(i)
            widget = self.tabWidget.widget(i)

            # –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
            if tab_name not in ("–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"):
                self.tabWidget.removeTab(i)

            # —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ —É —Å–ø–∏—Å–∫—É tab_name
            else:
                # —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ –∑—ñ —Å–ø–∏—Å–∫—É tab_name –º–∞—î –≤—ñ–¥–∂–µ—Ç,
                # —Ç–æ –æ—á–∏—â–∞—î–º–æ –π–æ–≥–æ
                if widget:
                    # –û—á–∏—â–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö, –∞ –Ω–µ –≤–∏–¥–∞–ª—è—î–º–æ —ó—Ö
                    layout = widget.layout()
                    if layout:
                        for j in reversed(range(layout.count())):
                            # –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤—ñ–¥–∂–µ—Ç–∏ –∑ layout
                            layout_item = layout.itemAt(j)
                            # —è–∫—â–æ –≤ layout_item —î –≤—ñ–¥–∂–µ—Ç, —Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ –π–æ–≥–æ
                            if layout_item.widget():
                                layout_item.widget().deleteLater()
                            layout.removeItem(layout_item)

        # –≤–∫–ª–∞–¥–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞" —É —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ –∫–æ–¥—É –∑–∞–≤–∂–¥–∏ —ñ—Å–Ω—É—î
        # –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞" –∑–∞–π–≤–∏–π –∫—Ä–æ–∫
        # QMessageBox.information(self, "xml_ua:", "tab –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∂–µ —ñ—Å–Ω—É—î")

        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –≤—ñ–¥–∂–µ—Ç–∏ CustomTreeView, TableViewMetadata, TableViewParcel
        # (–∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
        layout = self.tabXML.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç CustomTreeView –¥–µ—Ä–µ–≤–∞ xml
        self.treeViewXML = CustomTreeView(parent=self)
        self.treeViewXML.setObjectName("treeViewXML")
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç CustomTreeView –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
        layout.addWidget(self.treeViewXML)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–ú–µ—Ç–∞–¥–∞–Ω—ñ"
        layout = self.tabMetadata.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç TableViewMetadata –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö
        self.tableViewMetadata = TableViewMetadata(parent=self)
        self.tableViewMetadata.setObjectName("tableViewMetadata")
        self.tableViewMetadata.horizontalHeader().setStretchLastSection(True)
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç TableViewMetadata –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–ú–µ—Ç–∞–¥–∞–Ω—ñ"
        layout.addWidget(self.tableViewMetadata)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–î—ñ–ª—è–Ω–∫–∞"
        layout = self.tabParcel.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç TableViewParcel –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥—ñ–ª—è–Ω–æ–∫
        self.tableViewParcel = TableViewParcel(parent=self)
        self.tableViewParcel.setObjectName("tableViewParcel")
        self.tableViewParcel.horizontalHeader().setStretchLastSection(True)
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç TableViewParcel –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–î—ñ–ª—è–Ω–∫–∞"
        layout.addWidget(self.tableViewParcel)

        # –û—á–∏—â–∞—î–º–æ –¥–µ—Ä–µ–≤–æ, —Ç–∞–±–ª–∏—Ü—é –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —Ç–∞ —Ç–∞–±–ª–∏—Ü—é –¥—ñ–ª—è–Ω–æ–∫
        self.treeViewXML.model.clear()
        self.tableViewMetadata.model().clear()
        self.tableViewParcel.model().clear()

        # –û—Å–Ω–æ–≤–Ω–∏–π –µ—Ç–∞–ø - –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª XML

        xml_path, _ = QFileDialog.getOpenFileName(
            self, "–í—ñ–¥–∫—Ä–∏—Ç–∏ XML —Ñ–∞–π–ª", "", "XML —Ñ–∞–π–ª–∏ (*.xml)")

        if not xml_path:
            QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.")
            return

        # –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–æ:
        # –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Ñ–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ö–µ–º—ñ XSD
        # –ü—Ä–∞–∫—Ç–∏—á–Ω–æ:
        # —Ñ–∞–π–ª –∑–∞–≤–∂–¥–∏ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ö–µ–º—ñ XSD,
        # —Ö–æ—á–∞, –Ω—ñ–±–∏, –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Å–∞–º–µ –∑–≥—ñ–¥–Ω–æ –∑ –Ω–µ—é
        # –¢–æ–º—É —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ xml
        # —Ü–µ: –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞, –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        # –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö —Ç–µ–≥—ñ–≤ –∑–∞–∫—Ä–∏—Ç–∏–º, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
        # —Ç—É—Ç –ø–æ–∫–∏ –Ω–µ–ø–æ–≤–Ω–∞ —à–∏–≤–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
        if not self.validate_xml_structure(xml_path):
            log_msg(logFile, "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—É XML.")
            QMessageBox.warning(
                self, "–ü–æ–º–∏–ª–∫–∞", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—É XML.")
            return
        else:
            # log_msg(logFile, "–§–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ XML.")
            # QMessageBox.information(self, "–£—Å–ø—ñ—Ö", "–§–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ XML.")
            pass

        # –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∞—Ç—Ä–∏–±—É—Ç - –ø–æ–≤–Ω–µ —ñ–º'—è —Ñ–∞–π–ª—É xml
        self.full_xml_file_name = xml_path

        # current xml –º–∞—î 3 –∞—Ç—Ä–∏–±—É—Ç–∏: full_path, tree, group
        # 1) full_path
        self.current_xml.path = xml_path
        # –æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ñ–¥–∂–µ—Ç–∞
        self.update_window_title(self.current_xml.path)

        # –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É xml
        # –∑–∞–ø–æ–≤–Ω—é—î–º–æ –¥–µ—Ä–µ–≤–æ, —Ç–∞–±–ª–∏—Ü—é –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —Ç–∞ —Ç–∞–±–ª–∏—Ü—é –¥—ñ–ª—è–Ω–æ–∫
        # load data
        self.load_data(self.full_xml_file_name, tree = None)
        # 2) tree
        self.current_xml.tree = self.treeViewXML.xml_tree

        # –∫–æ–Ω—Ñ—ñ–≥—É—Ä—É—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–≥–ª—è–¥ –¥–µ—Ä–µ–≤–∞
        self.treeViewXML.expand_initial_elements()
        self.treeViewXML.set_column_width(0, 75)
        self.setup_custom_tab_buttons()

        # —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
        self.layers_obj = xmlUaLayers(xml_path, self.current_xml.tree, plugin=self.plugin) # Pass self.plugin
        # log_msg(logFile, f"{self.layers_obj}")
        # 3) group
        self.current_xml.group_name = self.layers_obj.group.name()
        # log_msg(logFile, f"{self.current_xml.group_name}")

        # current_xml –∑–º—ñ–Ω–∏—Ç—å—Å—è —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ xml
        # –∞–±–æ –ø—Ä–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –ø–æ –≥—Ä—É–ø–∞—Ö, —Ç–æ–º—É —Ç—Ä–µ–±–∞
        # –¥–æ —Å–ø–∏—Å–∫—É –¥–æ–¥–∞—Ç–∏ –π–æ–≥–æ –∫–ª–æ–Ω

        clone_xml = copy.deepcopy(self.current_xml)
        self.opened_xmls.append(clone_xml)

        # —Ü–µ–π –≤–∏–∫–ª–∏–∫ –º–∞–±—É—Ç—å —î –∑–∞–π–≤–∏–º –±–æ
        # –±–æ –¥—É–±–ª—é—î—Ç—å—Å—è —É xml_ua.py:on_open_tool
        self.plugin.connect_layer_signals()

        return


    def process_action_new(self, tree):
        """
        """
        # –ü—Ä–æ—Ü–µ—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ xml
        # –£ —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–±—Ä–∞–≤—à–∏ –ø—É–Ω–∫—Ç 
        # –º–µ–Ω—é "–ù–æ–≤–∏–π" –≤–∏–±—Ä–∞–≤ –ø–∞–ø–∫—É —ñ –Ω–∞–∑–≤—É —Ñ–∞–π–ª—É 
        # —à–∞–±–ª–æ–Ω –∑—á–∏—Ç–∞–Ω–∏–π —ñ —Ä–æ–∑–ø–∞—Ä—Å–µ–Ω–∏–π ???
        # —Ç—Ä–µ–±–∞ –∑–±–µ—Ä–µ–≥—Ç–∏ –¥–µ—Ä–µ–≤–æ xml –Ω–∞ –¥–∏—Å–∫ —ñ –≤—ñ–¥–∫—Ä–∏—Ç–∏ 
        # –≤—ñ–¥–∫—Ä–∏—Ç–∏ –π–æ–≥–æ –±–µ–∑ –ø–µ—Ä–µ–≤—ñ–æ–∫–∏ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –≤—Å—ñ—Ö
        # –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Å—Ö–µ–º–∏ –æ—Å–∫—ñ–ª—å–∫–∏ —Ñ–∞–π–ª
        # —É –ø—Ä–æ—Ü–µ—Å—ñ —Ä–æ–∑—Ä–æ–±–∫–∏
        
        log_calls(logFile)

        # –ü—ñ–¥–≥–æ—Ç–æ—á–∏–π –µ—Ç–∞–ø - –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º 
        # "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –≤—ñ–¥–∂–µ—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö
        # –æ—á–∏—â–∞—î–º–æ –º–æ–¥–µ–ª—ñ –≤—ñ–¥–∂–µ—Ç—ñ–≤ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö, –∞ –Ω–µ –≤–∏–¥–∞–ª—è—î–º–æ —ó—Ö

        # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º 
        # "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
        for i in reversed(range(self.tabWidget.count())):
            # —Ü–∏–∫–ª –¥–ª—è –∫–æ–∂–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏ —É –∑–≤–æ—Ä–æ—Ç–Ω—å–æ–º—É –ø–æ—Ä—è–¥–∫—É
            tab_name = self.tabWidget.tabText(i)
            widget = self.tabWidget.widget(i)

            # –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏, –∫—Ä—ñ–º "–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ" —ñ "–î—ñ–ª—è–Ω–∫–∞"
            if tab_name not in ("–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"):
                self.tabWidget.removeTab(i)

            # —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ —É —Å–ø–∏—Å–∫—É tab_name
            else:
                # —è–∫—â–æ –≤–∫–ª–∞–¥–∫–∞ –∑—ñ —Å–ø–∏—Å–∫—É tab_name –º–∞—î –≤—ñ–¥–∂–µ—Ç,
                # —Ç–æ –æ—á–∏—â–∞—î–º–æ –π–æ–≥–æ
                if widget:
                    # –û—á–∏—â–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–∞—Ö, –∞ –Ω–µ –≤–∏–¥–∞–ª—è—î–º–æ —ó—Ö
                    layout = widget.layout()
                    if layout:
                        for j in reversed(range(layout.count())):
                            # –≤–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –≤—ñ–¥–∂–µ—Ç–∏ –∑ layout
                            layout_item = layout.itemAt(j)
                            # —è–∫—â–æ –≤ layout_item —î –≤—ñ–¥–∂–µ—Ç, —Ç–æ –≤–∏–¥–∞–ª—è—î–º–æ –π–æ–≥–æ
                            if layout_item.widget():
                                layout_item.widget().deleteLater()
                            layout.removeItem(layout_item)

        # –≤–∫–ª–∞–¥–∫–∞ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞" —É —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ –∫–æ–¥—É –∑–∞–≤–∂–¥–∏ —ñ—Å–Ω—É—î
        # –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞" –∑–∞–π–≤–∏–π –∫—Ä–æ–∫
        # QMessageBox.information(self, "xml_ua:", "tab –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–∂–µ —ñ—Å–Ω—É—î")

        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –≤—ñ–¥–∂–µ—Ç–∏ CustomTreeView, TableViewMetadata, TableViewParcel
        # (–∫–æ–∂–Ω–æ–≥–æ —Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
        layout = self.tabXML.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç CustomTreeView –¥–µ—Ä–µ–≤–∞ xml
        self.treeViewXML = CustomTreeView(parent=self)
        self.treeViewXML.setObjectName("treeViewXML")
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç CustomTreeView –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—Ä—É–∫—Ç—É—Ä–∞"
        layout.addWidget(self.treeViewXML)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–ú–µ—Ç–∞–¥–∞–Ω—ñ"
        layout = self.tabMetadata.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç TableViewMetadata –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö
        self.tableViewMetadata = TableViewMetadata(parent=self)
        self.tableViewMetadata.setObjectName("tableViewMetadata")
        self.tableViewMetadata.horizontalHeader().setStretchLastSection(True)
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç TableViewMetadata –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–ú–µ—Ç–∞–¥–∞–Ω—ñ"
        layout.addWidget(self.tableViewMetadata)

        # –æ—Ç—Ä–∏–º—É—î–º–æ –≤–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ layuot (–ø–æ–ª–æ—Ç–Ω–æ) –≤–∫–ª–∞–¥–∫–∏ "–î—ñ–ª—è–Ω–∫–∞"
        layout = self.tabParcel.layout()
        # —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –≤—ñ–¥–∂–µ—Ç TableViewParcel –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥—ñ–ª—è–Ω–æ–∫
        self.tableViewParcel = TableViewParcel(parent=self)
        self.tableViewParcel.setObjectName("tableViewParcel")
        self.tableViewParcel.horizontalHeader().setStretchLastSection(True)
        # –¥–æ–¥–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç TableViewParcel –Ω–∞ –ø–æ–ª–æ—Ç–Ω–æ –≤–∫–ª–∞–¥–∫–∏ "–î—ñ–ª—è–Ω–∫–∞"
        layout.addWidget(self.tableViewParcel)

        # –û—á–∏—â–∞—î–º–æ –¥–µ—Ä–µ–≤–æ, —Ç–∞–±–ª–∏—Ü—é –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —Ç–∞ —Ç–∞–±–ª–∏—Ü—é –¥—ñ–ª—è–Ω–æ–∫
        self.treeViewXML.model.clear()
        self.tableViewMetadata.model().clear()
        self.tableViewParcel.model().clear()

        # –û—Å–Ω–æ–≤–Ω–∏–π –µ—Ç–∞–ø - –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ —Ñ–∞–π–ª XML

        # xml_path, _ = QFileDialog.getOpenFileName(
        #     self, "–í—ñ–¥–∫—Ä–∏—Ç–∏ XML —Ñ–∞–π–ª", "", "XML —Ñ–∞–π–ª–∏ (*.xml)")

        # if not xml_path:
        #     QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.")
        #     return

        # –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–æ:
        # –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Ñ–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ö–µ–º—ñ XSD
        # –ü—Ä–∞–∫—Ç–∏—á–Ω–æ:
        # —Ñ–∞–π–ª –∑–∞–≤–∂–¥–∏ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ö–µ–º—ñ XSD,
        # —Ö–æ—á–∞, –Ω—ñ–±–∏, –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Å–∞–º–µ –∑–≥—ñ–¥–Ω–æ –∑ –Ω–µ—é
        # –¢–æ–º—É —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ xml
        # —Ü–µ: –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞, –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        # –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–Ω—ñ—Å—Ç—å –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö —Ç–µ–≥—ñ–≤ –∑–∞–∫—Ä–∏—Ç–∏–º, –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
        # —Ç—É—Ç –ø–æ–∫–∏ –Ω–µ–ø–æ–≤–Ω–∞ —à–∏–≤–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
        # if not self.validate_xml_structure(xml_path):
        #     log_msg(logFile, "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—É XML.")
        #     QMessageBox.warning(
        #         self, "–ü–æ–º–∏–ª–∫–∞", "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—É XML.")
        #     return
        # else:
        #     # log_msg(logFile, "–§–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ XML.")
        #     # QMessageBox.information(self, "–£—Å–ø—ñ—Ö", "–§–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ XML.")
        #     pass

        # # –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∞—Ç—Ä–∏–±—É—Ç - –ø–æ–≤–Ω–µ —ñ–º'—è —Ñ–∞–π–ª—É xml
        # self.full_xml_file_name = xml_path

        # current xml –º–∞—î 3 –∞—Ç—Ä–∏–±—É—Ç–∏: full_path, tree, group
        # 1) full_path

        self.current_xml.path = xml_path
        # –æ–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ñ–¥–∂–µ—Ç–∞
        self.update_window_title(self.current_xml.path)

        # –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É xml
        # –∑–∞–ø–æ–≤–Ω—é—î–º–æ –¥–µ—Ä–µ–≤–æ, —Ç–∞–±–ª–∏—Ü—é –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —Ç–∞ —Ç–∞–±–ª–∏—Ü—é –¥—ñ–ª—è–Ω–æ–∫
        # load data
        self.load_data(self.full_xml_file_name, tree = None)
        # 2) tree
        self.current_xml.tree = self.treeViewXML.xml_tree

        # –∫–æ–Ω—Ñ—ñ–≥—É—Ä—É—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–≥–ª—è–¥ –¥–µ—Ä–µ–≤–∞
        self.treeViewXML.expand_initial_elements()
        self.treeViewXML.set_column_width(0, 75)
        self.setup_custom_tab_buttons()

        # —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
        #‚úîÔ∏è 2025.03.27 15:31 –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—è–¥–æ–∫ –∑–∞–π–≤–∏–π
        # –±–æ –Ω–∏–∂—á–µ —Ç–µ —Å–∞–º–µ –∑ —ñ–Ω—à–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        # self.layers_obj = xmlUaLayers(xml_path, self.current_xml.tree)
        # log_msg(logFile, f"{self.layers_obj}")
        # 3) group
        self.layers_obj = xmlUaLayers(xml_path, self.current_xml.tree, plugin=self.plugin) # Pass self.plugin
        # log_msg(logFile, f"{self.current_xml.group_name}")

        # current_xml –∑–º—ñ–Ω–∏—Ç—å—Å—è —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ xml
        # –∞–±–æ –ø—Ä–∏ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó –ø–æ –≥—Ä—É–ø–∞—Ö, —Ç–æ–º—É —Ç—Ä–µ–±–∞
        # –¥–æ —Å–ø–∏—Å–∫—É –¥–æ–¥–∞—Ç–∏ –π–æ–≥–æ –∫–ª–æ–Ω

        clone_xml = copy.deepcopy(self.current_xml)
        self.opened_xmls.append(clone_xml)

        return


    def resizeEvent(self, event):
        """
        –û–Ω–æ–≤–ª—é—î –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ñ–¥–∂–µ—Ç–∞ –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–æ–∑–º—ñ—Ä—É –≤—ñ–¥–∂–µ—Ç–∞.
        """
        super().resizeEvent(event)
        self.update_window_title(self.current_xml.path)

    def update_window_title(self, file_name):
        """
        –û–Ω–æ–≤–ª—é—î –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ñ–¥–∂–µ—Ç–∞, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –¥–æ—Å—Ç—É–ø–Ω—É —à–∏—Ä–∏–Ω—É —Ç–∞ 
        –æ–±—Ä—ñ–∑–∞—é—á–∏ –Ω–∞–∑–≤—É —Ñ–∞–π–ª—É, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.
        """
        # log_calls(logFile, f"file_name = '{file_name}'")

        # Check if the full_xml_file_name is set
        if not file_name:
            self.setWindowTitle("XML-—Ñ–∞–π–ª –æ–±–º—ñ–Ω—É –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é")
            return

        # Calculate available width for the title, subtracting 30 pixels for the menu buttons
        # title_width = self.width() - self.style().pixelMetric(QStyle.PM_DockWidgetTitleBarButtonMargin) * 2 - 60
        title_width = self.width() - 80
        # title_width = 150

        # Get the font metrics
        font_metrics = self.fontMetrics()

        # Elide (truncate) the path from the left (show the end)
        elided_text = font_metrics.elidedText(
            file_name, Qt.ElideLeft, title_width)

        # Set the elided text as the window title
        self.setWindowTitle(elided_text)

    def process_action_save(self):

        # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–µ—Ä–µ–≤–æ xml, –Ω–∞ –¥–∏—Å–∫ –∑—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º —ñ–º–µ–Ω–µ–º
        # –∑—á–∏—Ç–∞–Ω–∏–º –∑ –¥–∏—Å–∫—É, –∞–±–æ ???
        #‚úîÔ∏è 2025.03.21 14:45
        # –ø–æ–∫–∏ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –≤–∏–±–∏—Ä–∞—î—Ç—å—Å—è –ø–∞–ø–∫–∞ 
        # —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è ‚ùìüî® —á–∏ –¥–æ–∑–≤–æ–ª—è—Ç–∏ –≤–∏–±–∏—Ä–∞—Ç–∏ –ø–∞–ø–∫—É
        #         

        log_msg(logFile)

        frame = inspect.currentframe()

        # folder_path = QFileDialog.getExistingDirectory(
        #     None, "–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è")

        # if folder_path:
        #     full_path = f"{folder_path}/{self.full_xml_file_name}"

        #     self.treeViewXML.save_xml_tree(self.treeViewXML.xml_tree, full_path)
        if self.full_xml_file_name:
            self.treeViewXML.save_xml_tree(self.treeViewXML.xml_tree, self.full_xml_file_name)
            QMessageBox.information(None, "–£—Å–ø—ñ—Ö", f"–§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {self.full_xml_file_name}")
            return
        else:
            QMessageBox.warning(None, "–ü–æ–º–∏–ª–∫–∞", "–§–∞–π–ª –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π.")
            
            return


    def process_action_save_as(self):

        # –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è XML –º–æ–∂–ª–∏–≤–æ –≤ —ñ–Ω—à—É –ø–∞–ø–∫—É 
        # —ñ –ø—ñ–¥ —ñ–Ω—à–∏–º —ñ–º–µ–Ω–µ–º

        log_msg(logFile)

        # folder_path = QFileDialog.getExistingDirectory(
        #     self, "–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞–ø–∫—É –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è")
        # if not folder_path:
        #     QMessageBox.warning(self, "–ü–æ–º–∏–ª–∫–∞", "–ü–∞–ø–∫—É –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.")
        #     return

        # save_path = os.path.join(folder_path, "–∑–±–µ—Ä–µ–∂–µ–Ω–∏–π_—Ñ–∞–π–ª.xml")


        # –ó–∞–ø–∏—Ç—É—î–º–æ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —à–ª—è—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ XML —Ñ–∞–π–ª—É
        save_path, _ = QFileDialog.getSaveFileName(None, "–ó–±–µ—Ä–µ–≥—Ç–∏ XML —Ñ–∞–π–ª", "", "XML —Ñ–∞–π–ª–∏ (*.xml)")
        if not save_path:
            log_calls(logFile, "–®–ª—è—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–µ –≤–∏–±—Ä–∞–Ω–æ.")
            return None

        self.treeViewXML.save_xml_tree(self.treeViewXML.xml_tree, save_path)
        QMessageBox.information(self, "–£—Å–ø—ñ—Ö", f"–§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {save_path}")


    def get_tooltip_from_tree(self, full_path, default_name):
        """
        –û—Ç—Ä–∏–º—É—î tooltip –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç–∞ –∑ –¥–µ—Ä–µ–≤–∞ –∑–∞ –π–æ–≥–æ —à–ª—è—Ö–æ–º.
        –Ø–∫—â–æ tooltip –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–≤–µ—Ä—Ç–∞—î default_name.
        """
        # log_msg(logFile)  # recursion
        tree_index = self.find_element_index(
            path=full_path)  # –ü–æ—à—É–∫ –µ–ª–µ–º–µ–Ω—Ç–∞ –∑–∞ —à–ª—è—Ö–æ–º
        if tree_index.isValid():
            tree_item = self.treeViewXML.model.itemFromIndex(tree_index)
            if tree_item:
                return tree_item.toolTip() or default_name  # –ü–æ–≤–µ—Ä—Ç–∞—î tooltip –∞–±–æ default_name

        return default_name

    def find_element_index(self, path=None, element_name=None):
        """
        –ó–Ω–∞—Ö–æ–¥–∏—Ç—å —ñ–Ω–¥–µ–∫—Å –µ–ª–µ–º–µ–Ω—Ç–∞ —É –¥–µ—Ä–µ–≤—ñ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–ª—è—Ö—É –∞–±–æ —ñ–º–µ–Ω—ñ.
        """
        # log_msg(logFile) # recursion
        if path:
            # –õ–æ–≥—ñ–∫–∞ –ø–æ—à—É–∫—É –∑–∞ —à–ª—è—Ö–æ–º
            current_index = QModelIndex()
            path_parts = path.split("/")  # –†–æ–∑–¥—ñ–ª—è—î–º–æ —à–ª—è—Ö –Ω–∞ —á–∞—Å—Ç–∏–Ω–∏
            for part in path_parts:
                found = False
                for row in range(self.treeViewXML.model.rowCount(current_index)):
                    child_index = self.treeViewXML.model.index(
                        row, 0, current_index)
                    child_item = self.treeViewXML.model.itemFromIndex(
                        child_index)
                    if child_item and child_item.text() == part:
                        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –¥–µ—Ä–µ–≤–∞
                        current_index = child_index
                        found = True
                        break
                if not found:
                    # –Ø–∫—â–æ –±—É–¥—å-—è–∫–∞ —á–∞—Å—Ç–∏–Ω–∞ —à–ª—è—Ö—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø—É—Å—Ç–∏–π —ñ–Ω–¥–µ–∫—Å
                    return QModelIndex()
            return current_index
        elif element_name:
            # –õ–æ–≥—ñ–∫–∞ –ø–æ—à—É–∫—É –∑–∞ —ñ–º–µ–Ω–µ–º
            for row in range(self.treeViewXML.model.rowCount()):
                # –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —ñ–º–µ–Ω–∞ —É –ø–µ—Ä—à—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ
                item = self.treeViewXML.model.item(row, 0)
                if item and item.text() == element_name:
                    return self.treeViewXML.model.indexFromItem(item)
        return QModelIndex()

    def handle_error_and_close(self, error_message):
        """
            –û–±—Ä–æ–±–ª—è—î –ø–æ–º–∏–ª–∫—É, –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –∑–∞–∫—Ä–∏–≤–∞—î –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç.

            –ê—Ä–≥—É–º–µ–Ω—Ç–∏:
                –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É.
        """
        log_msg(logFile)

        self.parent.iface.messageBar().pushCritical("–ü–æ–º–∏–ª–∫–∞", error_message)
        self.close()

    def removeTab(self, index):
        tab_name = self.tabWidget.tabText(index)
        self.tabWidget.removeTab(index)
        if tab_name in self.opened_tabs:
            self.opened_tabs.remove(tab_name)
        self.update_restore_tabs_action()

    def showEvent(self, event):
        """ 
            –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –≤—ñ–∫–Ω–∞ 

        """
        # –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó –ø–æ–∫–∞–∑—É –≤—ñ–¥–∂–µ—Ç–∞.
        # –ü–æ–¥—ñ—è –≤–∏–Ω–∏–∫–∞—î, –ø–µ—Ä–µ–¥ —Ç–∏–º —è–∫ –≤—ñ–¥–∂–µ—Ç —Å—Ç–∞—î –≤–∏–¥–∏–º–∏–º.

        # log_calls(logFile, f"event = {event}")

        super().showEvent(event)
        if self.plugin and not self.isVisible():
            self.restore_tabs()
        # self.isVisible = True # we need to set the flag after calling self.restore_tabs()

    def close_tab(self, index):
        """
        Handle tab close events.
        """
        tab_name = self.tabWidget.tabText(index)

        log_msg(logFile, tab_name)
        if tab_name in ["–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"]:
            return

        if tab_name not in ["–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"]:
            self.closed_tabs.append(tab_name)
        self.removeTab(index)
        self.update_restore_tabs_action()
        self.update_tab_indices()

    def update_restore_tabs_action(self):
        """
        –û–Ω–æ–≤–ª—é—î —Å—Ç–∞–Ω –¥—ñ—ó "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞–∫—Ä–∏—Ç—ñ –≤–∫–ª–∞–¥–∫–∏".
        """
        if self.plugin:
            closed_tabs_exist = len(self.closed_tabs) > 0
            self.plugin.action_restore_tabs.setEnabled(closed_tabs_exist)

    def restore_tabs(self):
        """
        –í—ñ–¥–Ω–æ–≤–ª—é—î –≤–∫–ª–∞–¥–∫–∏, —â–æ –±—É–ª–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å–µ—Å—ñ—ó.
        """
        log_calls(logFile)

        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –≤–∫–ª–∞–¥–∫–∏, —è–∫—â–æ –≤–æ–Ω–∏ –±—É–ª–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ
        for tab_name in self.opened_tabs:
            if tab_name == "–°—Ç—Ä—É–∫—Ç—É—Ä–∞":
                self.add_tab("–°—Ç—Ä—É–∫—Ç—É—Ä–∞", self.tabXML)
            elif tab_name == "–ú–µ—Ç–∞–¥–∞–Ω—ñ":
                self.add_tab("–ú–µ—Ç–∞–¥–∞–Ω—ñ", self.tabMetadata)
            elif tab_name == "–î—ñ–ª—è–Ω–∫–∞":
                self.add_tab("–î—ñ–ª—è–Ω–∫–∞", self.tabParcel)

        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤–∫–ª–∞–¥–∫–∏ –∑—ñ —Å–ø–∏—Å–∫—É –∑–∞–∫—Ä–∏—Ç–∏—Ö, —è–∫—â–æ –≤–æ–Ω–∏ –±—É–ª–∏ –∑–∞–∫—Ä–∏—Ç—ñ –≤ –ø–æ—Ç–æ—á–Ω—ñ–π —Å–µ—Å—ñ—ó
        for tab_name in self.closed_tabs:
            if tab_name not in self.opened_tabs:
                if tab_name not in ["–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–ú–µ—Ç–∞–¥–∞–Ω—ñ", "–î—ñ–ª—è–Ω–∫–∞"]:
                    self.opened_tabs.append(tab_name)

        self.setup_custom_tab_buttons()
        if self.plugin and hasattr(self.plugin, 'update_restore_tabs_action'):
            self.plugin.update_restore_tabs_action()

    def update_restore_tabs_action(self):
        """
        –û–Ω–æ–≤–ª—é—î —Å—Ç–∞–Ω –¥—ñ—ó "–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑–∞–∫—Ä–∏—Ç—ñ –≤–∫–ª–∞–¥–∫–∏".
        """
        if self.plugin:
            closed_tabs_exist = len(self.closed_tabs) > 0
            self.plugin.action_restore_tabs.setEnabled(closed_tabs_exist)

    def removeTab(self, index):
        tab_name = self.tabWidget.tabText(index)
        self.tabWidget.removeTab(index)
        if tab_name in self.opened_tabs:
            self.opened_tabs.remove(tab_name)
        self.update_restore_tabs_action()

    def restore_tabs(self):
        """
        –í—ñ–¥–Ω–æ–≤–ª—é—î –≤–∫–ª–∞–¥–∫–∏, —â–æ –±—É–ª–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å–µ—Å—ñ—ó.
        """
        log_calls(logFile, f"closed_tabs: {self.closed_tabs}")

        # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –≤–∫–ª–∞–¥–∫–∏ –∑—ñ —Å–ø–∏—Å–∫—É –∑–∞–∫—Ä–∏—Ç–∏—Ö
        for tab_name in self.closed_tabs:
            if tab_name not in self.opened_tabs:
                if tab_name == "–°—Ç—Ä—É–∫—Ç—É—Ä–∞":
                    self.add_tab("–°—Ç—Ä—É–∫—Ç—É—Ä–∞", self.tabXML)
                    self.load_data(self.full_xml_file_name)
                elif tab_name == "–ú–µ—Ç–∞–¥–∞–Ω—ñ":
                    self.add_tab("–ú–µ—Ç–∞–¥–∞–Ω—ñ", self.tabMetadata)
                    self.load_data(self.full_xml_file_name)
                elif tab_name == "–î—ñ–ª—è–Ω–∫–∞":
                    self.add_tab("–î—ñ–ª—è–Ω–∫–∞", self.tabParcel)
                    self.load_data(self.full_xml_file_name)
                else:
                    # –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏
                    self.add_tab(tab_name, QWidget())

        self.closed_tabs.clear()
        self.setup_custom_tab_buttons()
        if self.plugin and hasattr(self.plugin, 'update_restore_tabs_action'):
            self.plugin.update_restore_tabs_action()


    def update_tab_indices(self):
        """
        –û–Ω–æ–≤–ª—é—î —ñ–Ω–¥–µ–∫—Å–∏ –≤–∫–ª–∞–¥–æ–∫ –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è.
        """

        log_calls(logFile)

        for i in range(self.tabWidget.count()):
            tab_bar = self.tabWidget.tabBar()
            tab_button = tab_bar.tabButton(i, QTabBar.RightSide)
            if tab_button:
                # Disconnect old connections
                try:
                    connector.disconnect(tab_button, "clicked", self.tab_button_clicked)
                except TypeError:
                    pass

                # Set new object name and connect the button
                tab_button.setObjectName(f"tab_close_button_{i}")
                # Use lambda to pass the index correctly
                connector.connect(tab_button, "clicked", lambda _, idx=i: self.tab_button_clicked(idx))


    def generate_layers_obj_name(self, base_name):
        """
        –§–æ—Ä–º—É—î –Ω–∞–∑–≤—É –≥—Ä—É–ø–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –±–∞–∑–æ–≤–æ—ó –Ω–∞–∑–≤–∏, –¥–æ–¥–∞—é—á–∏ —Å—É—Ñ—ñ–∫—Å, —è–∫—â–æ –≥—Ä—É–ø–∞ –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î.

        Args:
            base_name (str): –ë–∞–∑–æ–≤–∞ –Ω–∞–∑–≤–∞ –≥—Ä—É–ø–∏ (–Ω–∞–∑–≤–∞ —Ñ–∞–π–ª—É –±–µ–∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è).

        Returns:
            str: –ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏.
        """
        layers_obj_name = base_name
        suffix = 0

        while self.layers_root.findGroup(layers_obj_name):
            suffix += 1
            layers_obj_name = f"{base_name}#{suffix}"

        return layers_obj_name

    def double_clicked(self, index):
        """
        –û–±—Ä–æ–±–ª—è—î –ø–æ–¥–≤—ñ–π–Ω–µ –∫–ª–∞—Ü–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ –≤ –¥–µ—Ä–µ–≤—ñ —à–∞—Ä—ñ–≤.
        """
        log_calls(logFile, f"index = {index}")

        # –û—Ç—Ä–∏–º—É—î–º–æ QgsLayerTreeNode, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ QgsLayerTreeView
        item = self.iface.layerTreeView().index2node(index)

        if item is None:
            log_msg(logFile, f"item is None")
            return

        # log_msg(logFile, f"item.name() = {item.name()}")

        if isinstance(item, QgsLayerTreeGroup):
            layers_obj_name = item.name()
            log_msg(
                logFile, f"layers_obj_name = {layers_obj_name}")

    def clicked(self, index):
        """
        –û–±—Ä–æ–±–ª—è—î  –∫–ª–∞—Ü–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ –≤ –¥–µ—Ä–µ–≤—ñ —à–∞—Ä—ñ–≤.
        """
        # log_calls(logFile, f"index = {index}")

        # –û—Ç—Ä–∏–º—É—î–º–æ QgsLayerTreeNode, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ QgsLayerTreeView
        item = self.iface.layerTreeView().index2node(index)

        if item is None:
            log_msg(logFile, f"item is None")
            return

        if isinstance(item, QgsLayerTreeGroup):
            self.process_group_click(item.name())

    def validate_xml_structure(self, xml_path):

        #‚úîÔ∏è 2025.04.03 08:59
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ç—Ä–µ–±–∞ xml –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —ñ —à–∞–±–ª–æ–Ω–∏ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ, –±–æ
        # –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É —É —à–∞–±–ª–æ–Ω—ñ 
        # –¶–µ —á–∞—Å—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ XML
        # –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ XML –∑–∞—Å–æ–±–∞–º–∏ library lxml
        # –Ω–µ –ø—Ä–∞—Ü—é—î, –±–æ –í–°–Ü —Ñ–∞–π–ª–∏ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Å—Ö–µ–º—ñ XSD
        # —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É —Ç—Ä–µ–±–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
        # –∑ –≤—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ç–æ–≥–æ, —â–æ —Ñ–∞–π–ª –º–æ–∂–µ –±—É—Ç–∏ —É –ø—Ä–æ—Ü–µ—Å—ñ —Ä–æ–∑—Ä–æ–±–∫–∏

        #‚úîÔ∏è 2025.04.03  
        # log_msg(logFile)

        # –°–ø–∏—Å–æ–∫ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        mandatory_elements = [
            "AdditionalPart",
            "ServiceInfo",
            "FileID",
            "FormatVersion",
            "FileDate",
            "FileGUID",
            "ReceiverName",
            "ReceiverIdentifier",
            "Software",
            "SoftwareVersion",
            "InfoLandWork",
            "Executor",
            "CompanyName",
            "Chief",
            "Address",
            "InfoPart",
            "MetricInfo",
            "CoordinateSystem",
            "HeightSystem",
            "MeasurementUnit",
            "PointInfo",
            "Polyline",
            "ControlPoint",
            "CadastralZoneInfo",
            "CadastralZoneNumber",
            "CadastralQuarterInfo",
            "CadastralQuarterNumber",
            "ParcelInfo",
            "ParcelMetricInfo"
        ]
        try:
            # 1. Parse the XML (Well-Formedness Check)
            tree = etree.parse(xml_path)
            root = tree.getroot()

            # 2. Check for a Root Element
            if root is None:
                log_msg(logFile, "Error: No root element found in the XML file.")
                return False

            # Check if the root element's tag is 'UkrainianCadastralExchangeFile'
            if root.tag != "UkrainianCadastralExchangeFile":
                log_msg(
                    logFile, f"Error: Root element is '{root.tag}', expected 'UkrainianCadastralExchangeFile'.")
                return False

            for element_name in mandatory_elements:
                element = root.find(".//" + element_name)
                if element is None:
                    log_msg(
                        logFile, f"Error: Mandatory element '{element_name}' is missing.")
                    return False
        except Exception as e:
            log_msg(logFile, f"Error during XML structure validation: {e}")
            return False

        return True


    def process_group_click(self, group_name):


        # –û—Å–Ω–æ–≤–Ω–∞ –º–µ—Ç–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –¥–æ–∫–≤—ñ–¥–∂–µ—Ç –∑ –≤–∏–±—Ä–∞–Ω–æ—é –≥—Ä—É–ø–æ—é 
        # –≤ –¥–µ—Ä–µ–≤—ñ —à–∞—Ä—ñ–≤ QGIS –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–ª–∞—Ü–∞—î –≥—Ä—É–ø—É, 

        log_calls(logFile, group_name)

        if not hasattr(self, 'opened_xmls'):
            QMessageBox.warning(self, "process_group_click()",
                                "not hasattr(self, 'opened_xmls')")
            log_msg(logFile, "Error: opened_xmls attribute is not initialized.")
            return

        layers_root = QgsProject.instance().layerTreeRoot()
        clicked_group = layers_root.findGroup(group_name)
        #log_msg(logFile, f"clicked_group = {clicked_group}")
        if not clicked_group:
            log_msg(
                logFile, f"Group '{group_name}' not found in the layer tree")
            return

        # —à—É–∫–∞—î–º–æ –µ–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫—É –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö xml,
        found = False
        for xml in self.opened_xmls:
            if xml.group_name == group_name:
                self.current_xml = xml
                found = True
                log_msg(logFile, f"Group '{group_name}' found in opened_xmls")
                # QMessageBox.information(self, "process_group_click()","group " + group_name + " found")
                break

        if not found:
            log_msg(logFile, f"–ù–µ–º–∞ –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ xml –∑ —ñ–º–µ–Ω–µ–º '{group_name}'")
            return

        if self.isHidden():
            self.show()

        # ‚úîÔ∏è 2025.03.08 10:01 –æ—á–∏—Å—Ç–∫–∞_–≤—ñ–∫–Ω–∞
        self.plugin.clear_widget_data()

        self.load_data(self.current_xml.path, self.current_xml.tree)
        self.treeViewXML.expand_initial_elements()
        self.treeViewXML.set_column_width(0, 75)

        # –∫–æ–Ω—Ñ—ñ–≥—É—Ä—É—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–≥–ª—è–¥ –¥–µ—Ä–µ–≤–∞
        self.treeViewXML.expand_initial_elements()
        self.treeViewXML.set_column_width(0, 75)
        self.setup_custom_tab_buttons()

        # –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫–≤—ñ–¥–∂–µ—Ç–∞
        self.update_window_title(self.current_xml.path)


    # def on_layer_geometry_changed(self, layer_id, feature_id, geometry):

    #     """
    #     –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó –∑–º—ñ–Ω–∏ –≥–µ–æ–º–µ—Ç—Ä—ñ—ó —Ñ—ñ—á—ñ —à–∞—Ä—É.
    #     """

    #     log_calls(logFile, f"layer_id: {layer_id}, feature_id: {feature_id}, geometry: {geometry}")

    #     # –û—Ç—Ä–∏–º—É—î–º–æ —à–∞—Ä –∑–∞ –π–æ–≥–æ ID
    #     # instance() -> –ø–æ—Ç–æ—á–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–æ—î–∫—Ç—É QGIS
    #     layer = QgsProject.instance().mapLayer(layer_id) 
    #     if not layer:
    #         log_msg(logFile, f"–®–∞—Ä –∑ ID {layer_id} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
    #         return

    #     # –û—Ç—Ä–∏–º—É—î–º–æ —Ñ—ñ—á—É –∑–∞ —ó—ó ID
    #     feature = layer.getFeature(feature_id)
    #     if not feature:
    #         log_msg(logFile, f"–§—ñ—á–∞ –∑ ID {feature_id} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ —à–∞—Ä—ñ {layer.name()}.")
    #         return

    #     # –û—Ç—Ä–∏–º—É—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é —Ñ—ñ—á—ñ
    #     new_geometry = feature.geometry()
    #     log_msg(logFile, f"–ù–æ–≤–∞ –≥–µ–æ–º–µ—Ç—Ä—ñ—è —Ñ—ñ—á—ñ: {geometry_to_string(new_geometry)}")

    #     # –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è XML-—Ñ–∞–π–ª—É
    #     # –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–æ–≤–æ—ó –≥–µ–æ–º–µ—Ç—Ä—ñ—ó
    #     if self.dockwidget:
    #         self.dockwidget.update_xml_with_new_geometry(layer, feature, new_geometry)

    def update_xml_with_new_geometry(self, layer, feature_id, geometry):
        """
        –û–Ω–æ–≤–ª—é—î XML-—Ñ–∞–π–ª –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–æ–≤–æ—ó –≥–µ–æ–º–µ—Ç—Ä—ñ—ó.
        """
        # log_calls(logFile, f"layer: {layer.name()}, feature_id: {feature_id}, geometry: {geometry}")
        log_calls(logFile)

        # –û—Ç—Ä–∏–º—É—î–º–æ —Ñ—ñ—á—É –∑–∞ —ó—ó ID
        feature = layer.getFeature(feature_id)
        if not feature:
            log_msg(logFile, f"–§—ñ—á–∞ –∑ ID {feature_id} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –≤ —à–∞—Ä—ñ {layer.name()}.")
            return

        # –û—Ç—Ä–∏–º—É—î–º–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é —Ñ—ñ—á—ñ
        new_geometry = feature.geometry()
        log_calls(logFile, f"–ù–æ–≤–∞ –≥–µ–æ–º–µ—Ç—Ä—ñ—è —Ñ—ñ—á—ñ: {geometry_to_string(new_geometry)}")

        # TODO: –¢—É—Ç –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è 
        # XML-—Ñ–∞–π–ª—É –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–æ–≤–æ—ó –≥–µ–æ–º–µ—Ç—Ä—ñ—ó
        QMessageBox.information(self, "update_xml_with_new_geometry()", f"–ù–æ–≤–∞ –≥–µ–æ–º–µ—Ç—Ä—ñ—è —Ñ—ñ—á—ñ: {geometry_to_string(new_geometry)}")
        
