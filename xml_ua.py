# -*- coding: utf-8 -*-
# xml_ua.py
"""
/***************************************************************************
 xml_ua
                                 A QGIS plugin
 Processing ukrainian cadastral files.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2024-11-01
        git sha              : $Format:%H$
        copyright            : (C) 2025 by Michael.Krechkivski@gmail.com
        email                : michael.krechkivski@gmail.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""
#‚úîÔ∏è 2025.10.02 12:24
# region Import 
import os
import os.path
import math
import shutil
import glob
import copy

from qgis.core import Qgis
from qgis.core import QgsGeometry
from qgis.core import QgsFeature
from qgis.core import QgsWkbTypes
from qgis.core import QgsMapLayer
from qgis.core import QgsProject
from qgis.core import QgsVectorLayer
from qgis.core import QgsVectorLayerEditUtils
from qgis.core import QgsLayerTreeGroup
from qgis.core import QgsRasterLayer
from qgis.core import QgsLayerTreeLayer
from qgis.gui import QgsLayerTreeViewMenuProvider
from qgis.core import QgsApplication

from qgis.PyQt.QtCore import Qt
from qgis.PyQt.QtCore import QObject
from qgis.PyQt.QtCore import QSettings
from qgis.PyQt.QtCore import QTranslator
from qgis.PyQt.QtCore import QCoreApplication

from qgis.PyQt.QtGui import QIcon

from qgis.PyQt.QtWidgets import QAction
from qgis.PyQt.QtWidgets import QMenu
from qgis.PyQt.QtWidgets import QToolBar
from qgis.PyQt.QtWidgets import QToolButton
from qgis.PyQt.QtWidgets import QMessageBox
from qgis.PyQt.QtWidgets import QStyle
from qgis.PyQt.QtWidgets import QInputDialog
from qgis.PyQt.QtWidgets import QFileDialog
from lxml import etree

from qgis.core import QgsWkbTypes
# –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞ QgisInterface
from qgis.utils import iface
# —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π Gemini –≤–∞—Ä—ñ–∞–Ω—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞ QgisInterface
# from qgis.gui import QgisInterface


#from PyQt5.QtWidgets import QMessageBox

# Initialize Qt resources from file resources.py
from .resources import *

# Import the code for the DockWidget
from .dockwidget import xml_uaDockWidget
#from .layers import xmlUaLayers
from .points import Points
from .lines import PLs
from .zone import CadastralZoneInfo
from .quarters import CadastralQuarters
from .parcels import CadastralParcel
from .lands import LandsParcels
from .leases import Leases
from .subleases import Subleases
from .restrictions import Restrictions
from .adjacents import AdjacentUnits

from .common import size
from .common import logFile
from .common import log_msg
from .common import connector
from .common import xml_template
from .common import geometry_to_string
from .new_xml import NewXmlCreator

# endregion

#class xml_ua(QgsLayerTreeViewMenuProvider):
class xml_ua:
    """QGIS Plugin Implementation."""

    # after load QGIS, without project 
    def __init__(self, iface):

    #‚úîÔ∏è 2025.05.17 —Ü–µ–π –≤–∞—Ä—ñ–∞–Ω—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π Gemini –∞–Ω–∞–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ—á–∞—Ç–∫–æ–≤–æ–º—É
    # def __init__(self, iface: QgisInterface):
        """Constructor.

        :param iface: An interface instance that will be passed to this class
            which provides the hook by which you can manipulate the QGIS
            application at run time.
        :type iface: QgsInterface
        """
        #super().__init__()
        #‚úîÔ∏è 2025.05.17 —É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è—Ö: iface: QgisInterface
        # –∞ –±—É–ª–æ: from qgis.utils import iface
        # log_calls(logFile, f"iface = {iface}")

        self.iface = iface
        self.project = None
        self.xml_layers = None
        self.plugin_dir = os.path.dirname(__file__)
        locale = QSettings().value('locale/userLocale')[0:2]
        locale_path = os.path.join(self.plugin_dir,'i18n',f'xml_ua_{locale}.qm')
        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            QCoreApplication.installTranslator(self.translator)

        self.actions = []
        self.menu = self.tr(u'&xml_ua')
        self.toolbar = None 
        self.pluginIsActive = False
        self.dockwidget = None
        self.dockwidget_visible = False
        self.new_xml = ""

        self.map_canvas_context_handler = None
        # –°–∏–≥–Ω–∞–ª layersAdded –ø–µ—Ä–µ–¥–∞—î —Å–ø–∏—Å–æ–∫ —É—Å—ñ—Ö —à–∞—Ä—ñ–≤, —è–∫—ñ –±—É–ª–∏ –¥–æ–¥–∞–Ω—ñ 
        # –¥–æ –ø—Ä–æ–µ–∫—Ç—É –∑ –º–æ–º–µ–Ω—Ç—É –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –≤–∏–∫–ª–∏–∫—É —Å–∏–≥–Ω–∞–ª—É, –∞ –Ω–µ —Ç—ñ–ª—å–∫–∏ 
        # –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–æ–¥–∞–Ω–∏–π —à–∞—Ä. –¢–æ–º—É, —â–æ–± –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫–∏–π —à–∞—Ä –±—É–≤ –¥–æ–¥–∞–Ω–∏–π 
        # –æ—Å—Ç–∞–Ω–Ω—ñ–º, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ—Ä—ñ–≤–Ω—é–≤–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ —à–∞—Ä—ñ–≤ –∑ 
        # –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º —Å—Ç–∞–Ω–æ–º. –¶–µ –≤–∏–º–∞–≥–∞—î –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó –ª–æ–≥—ñ–∫–∏ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è 
        # —à–∞—Ä—ñ–≤, —è–∫—ñ –≤–∂–µ —ñ—Å–Ω—É—é—Ç—å.

        # –©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—ñ–≤ –¥–æ –≤–∂–µ —ñ—Å–Ω—É—é—á–∏—Ö —à–∞—Ä—ñ–≤,
        self.existing_layer_ids = set()
        # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–æ —Å–∏–≥–Ω–∞–ª—É –ø—Ä–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞—Ä—É
        # –Ø–∫—â–æ —É QGIS –≤—ñ–¥–±—É–ª–∞—Å—è –ø–æ–¥—ñ—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞—Ä—É, —Ç–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è
        # —Å–∏–≥–Ω–∞–ª layersAdded, —è–∫–∏–π –ø–µ—Ä–µ–¥–∞—î —Å–ø–∏—Å–æ–∫ –£–°–Ü–• —à–∞—Ä—ñ–≤



    def tr(self, message): # after load QGIS, without project
        """Get the translation for a string using Qt translation API.

        We implement this ourselves since we do not inherit QObject.

        :param message: String for translation.
        :type message: str, QString

        :returns: Translated version of message.
        :rtype: QString
        """
        # noinspection PyTypeChecker,PyArgumentList,PyCallByClass
        # #log_msg(logFile, "xml_ua")
        return QCoreApplication.translate('xml_ua', message)
    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None):
        """Add a toolbar icon to the toolbar.

        :param icon_path: Path to the icon for this action. Can be a resource
            path (e.g. ':/plugins/foo/bar.png') or a normal file system path.
        :type icon_path: str

        :param text: Text that should be shown in menu items for this action.
        :type text: str

        :param callback: Function to be called when the action is triggered.
        :type callback: function

        :param enabled_flag: A flag indicating if the action should be enabled
            by default. Defaults to True.
        :type enabled_flag: bool

        :param add_to_menu: Flag indicating whether the action should also
            be added to the menu. Defaults to True.
        :type add_to_menu: bool

        :param add_to_toolbar: Flag indicating whether the action should also
            be added to the toolbar. Defaults to True.
        :type add_to_toolbar: bool

        :param status_tip: Optional text to show in a popup when mouse pointer
            hovers over the action.
        :type status_tip: str

        :param parent: Parent widget for the new action. Defaults None.
        :type parent: QWidget

        :param whats_this: Optional text to show in the status bar when the
            mouse pointer hovers over the action.

        :returns: The action that was created. Note that the action is also
            added to self.actions list.
        :rtype: QAction
        """

        #log_msg(logFile)

        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip is not None:
            action.setStatusTip(status_tip)

        if whats_this is not None:
            action.setWhatsThis(whats_this)

        if add_to_toolbar:
            self.toolbar.addAction(action)

        if add_to_menu:
            self.iface.addPluginToVectorMenu(
                self.menu,
                action)

        self.actions.append(action)

        return action
    def onClosePlugin(self):
        """Cleanup necessary items here when plugin dockwidget is closed"""

        # disconnects
        self.dockwidget.closingPlugin.disconnect(self.onClosePlugin)

        # remove this statement if dockwidget is to remain
        # for reuse if plugin is reopened
        # Commented next statement since it causes QGIS crashe
        self.dockwidget = None

        self.pluginIsActive = False

    def unload(self):
        """–í—ñ–¥–∫–ª—é—á–∞—î —Å–∏–≥–Ω–∞–ª–∏, –≤–∏–¥–∞–ª—è—î –µ–ª–µ–º–µ–Ω—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Ç–∞ –æ—á–∏—â—É—î —Ä–µ—Å—É—Ä—Å–∏ –ø—Ä–∏ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø–ª–∞–≥—ñ–Ω–∞."""
        #log_msg(logFile, "–ü–æ—á–∞—Ç–æ–∫ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–≥—ñ–Ω–∞.")

        # –í—ñ–¥'—î–¥–Ω—É—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏
        self.disconnect_map_canvas_context()

        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –ù–∞–¥—ñ–π–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –≤—Å—ñ—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ ---
        # 1. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ —ñ—Å–Ω—É—é—á—ñ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç–∏ —Ü—å–æ–≥–æ –ø–ª–∞–≥—ñ–Ω–∞.
        existing_dockwidgets = self.iface.mainWindow().findChildren(xml_uaDockWidget)
        #log_msg(logFile, f"–ó–Ω–∞–π–¥–µ–Ω–æ {len(existing_dockwidgets)} –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç—ñ–≤ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è.")

        # 2. –°–ø–æ—á–∞—Ç–∫—É –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏ —Ç–∞ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ –Ω–∏–º–∏ –≥—Ä—É–ø–∏ —à–∞—Ä—ñ–≤ —É –∫–æ–∂–Ω–æ–º—É –≤—ñ–¥–∂–µ—Ç—ñ.
        for dw in existing_dockwidgets:
            if hasattr(dw, 'opened_xmls') and dw.opened_xmls:
                opened_xmls_copy = list(dw.opened_xmls)
                for xml_data in opened_xmls_copy:
                    dw.process_action_close_xml(xml_data, force_close=True)

        # 3. –ü—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –≤–∫–ª–∞–¥–æ–∫, –≤–∏–¥–∞–ª—è—î–º–æ —Å–∞–º—ñ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç–∏ –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É QGIS.
        for dw in existing_dockwidgets:
            try:
                dw.closingPlugin.disconnect(self.onClosePlugin)
            except (TypeError, RuntimeError):
                pass
            self.iface.removeDockWidget(dw)
        self.dockwidget = None  # –û—á–∏—â—É—î–º–æ –æ—Å–Ω–æ–≤–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        # --- –ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω ---

        # –í–∏–¥–∞–ª—è—î–º–æ –¥—ñ—ó —Ç–∞ —Ç—É–ª–±–∞—Ä –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É QGIS
        for action in self.actions:
            self.iface.removePluginVectorMenu(
                self.tr(u'&xml_ua'),
                action)
            self.iface.removeToolBarIcon(action)
        # –í–∏–¥–∞–ª—è—î–º–æ —Ç—É–ª–±–∞—Ä, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î
        if self.toolbar:
            try:
                self.iface.mainWindow().removeToolBar(self.toolbar)
                #log_msg(logFile, f"–¢—É–ª–±–∞—Ä '{self.toolbar.objectName()}' –≤–∏–¥–∞–ª–µ–Ω–æ.")
            except Exception as e:
                #log_msg(logFile, f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç—É–ª–±–∞—Ä: {e}")
                pass
            self.toolbar = None

        # –í—ñ–¥–∫–ª—é—á–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ —Å–∏–≥–Ω–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç—É
        try:
            QgsProject.instance().layersAdded.disconnect(self.on_layers_added)
            #log_msg(logFile, "–°–∏–≥–Ω–∞–ª 'layersAdded' —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ.")
        except TypeError:
            # –°–∏–≥–Ω–∞–ª –Ω–µ –±—É–≤ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π
            pass

    def disconnect_map_canvas_context(self):
        """–í—ñ–¥'—î–¥–Ω—É—î –æ–±—Ä–æ–±–Ω–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –≤—ñ–¥ –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏."""
        if hasattr(self, 'map_canvas_context_handler') and self.map_canvas_context_handler:
            canvas = self.iface.mapCanvas()
            if canvas:
                try:
                    canvas.contextMenuAboutToShow.disconnect(self.map_canvas_context_handler)
                    #log_msg(logFile, "–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥'—î–¥–Ω–∞–Ω–æ.")
                except TypeError:
                    # –Ü–≥–Ω–æ—Ä—É—î–º–æ –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ —Å–∏–≥–Ω–∞–ª –Ω–µ –±—É–≤ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π
                    pass
            self.map_canvas_context_handler = None

    def on_feature_added(self, layer, feature_id):
        # QMessageBox.information(
        #     self.iface.mainWindow(),
        #     "–°–∏–≥–Ω–∞–ª: on_feature_added",
        #     f"–î–æ–¥–∞–Ω–æ —Ñ—ñ—á—É –¥–æ —à–∞—Ä—É: '{layer.name()}'"
        # )
        #log_msg(logFile, f"–î–æ–¥–∞–Ω–æ —Ñ—ñ—á—É ID:{feature_id} –¥–æ —à–∞—Ä—É: '{layer.name()}'")
        pass


    def on_feature_removed(self, layer, feature_id):
        try:

            # QMessageBox.information(
            #     self.iface.mainWindow(),
            #     "–°–∏–≥–Ω–∞–ª: on_feature_removed",
            #     f"–í–∏–¥–∞–ª–µ–Ω–æ —Ñ—ñ—á—É ID:{feature_id} –∑ —à–∞—Ä—É: '{layer.name()}'"
            # )
            #log_msg(logFile, f"–í–∏–¥–∞–ª–µ–Ω–æ —Ñ—ñ—á—É ID:{feature_id} –∑ —à–∞—Ä—É: '{layer.name()}'")
            pass
        except RuntimeError:
            #log_msg(logFile, "–ü–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–æ RuntimeError: —à–∞—Ä –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ –Ω–∞ —Ä—ñ–≤–Ω—ñ C++.")
            pass
            return

    def on_committed_features_removed(self, layer_id, feature_ids):
        """–ü–µ—Ä–µ–¥–∞—î –∫–µ—Ä—É–≤–∞–Ω–Ω—è –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç—É –ø—ñ—Å–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤."""
        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ AttributeError ---
        # –°–∏–≥–Ω–∞–ª committedFeaturesRemoved –ø–µ—Ä–µ–¥–∞—î layer_id (—Ä—è–¥–æ–∫), –∞ –Ω–µ –æ–±'—î–∫—Ç —à–∞—Ä—É.
        # –û—Ç—Ä–∏–º—É—î–º–æ –æ–±'—î–∫—Ç —à–∞—Ä—É –∑–∞ –π–æ–≥–æ ID.
        layer = QgsProject.instance().mapLayer(layer_id)
        if not layer:
            return # –®–∞—Ä –º—ñ–≥ –±—É—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–∏–π

        if self.dockwidget:
            self.dockwidget.handle_committed_features_removed(layer, feature_ids)
        # --- –ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω ---

    def on_geometry_changed(self, layer, feature_id, geom):
        # QMessageBox.information(
        #     self.iface.mainWindow(),
        #     "–°–∏–≥–Ω–∞–ª: on_geometry_changed",
        #     f"–ó–º—ñ–Ω–µ–Ω–æ –≥–µ–æ–º–µ—Ç—Ä—ñ—é –¥–ª—è —à–∞—Ä—É: '{layer.name()}'\nID —Ñ—ñ—á—ñ: {feature_id}"
        # )
        #log_msg(logFile, f"–ì–µ–æ–º–µ—Ç—Ä—ñ—é –∑–º—ñ–Ω–µ–Ω–æ –¥–ª—è —à–∞—Ä—É '{layer.name()}', feature_id: {feature_id}")
        if self.dockwidget and self.is_layer_in_opened_xmls_group(layer):
            self.dockwidget.update_xml_from_geometry_change(layer, feature_id)

    def is_layer_in_opened_xmls_group(self, layer):
        """
        –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –Ω–∞–ª–µ–∂–∏—Ç—å —à–∞—Ä –¥–æ –æ–¥–Ω—ñ—î—ó –∑ –≥—Ä—É–ø, —â–æ –≤—Ö–æ–¥—è—Ç—å –¥–æ opened_xmls.

        Args:
            layer (QgsVectorLayer): –®–∞—Ä –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏.

        Returns:
            bool: True, —è–∫—â–æ —à–∞—Ä –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ –æ–¥–Ω—ñ—î—ó –∑ –≥—Ä—É–ø, —ñ–Ω–∞–∫—à–µ False.
        """

        layer_name = layer.name()
        #log_msg(logFile, f"'{layer_name}'")

        if not self.dockwidget or not hasattr(self.dockwidget, 'opened_xmls'):
            return False

        project = QgsProject.instance()
        root = project.layerTreeRoot()

        for xml_data in self.dockwidget.opened_xmls:
            group_name = xml_data.group_name
            group = root.findGroup(group_name)

            if group:
                for child in group.children():
                    if isinstance(child, QgsLayerTreeLayer):
                        if child.layer() == layer:
                            return True
        return False
    

    def run(self):
        """
        Executes the plugin's main functionality.
        Called from on_open_tool()

        This method performs the following actions:
        1. Logs the function call.
        2. Checks if a QGIS project is open. If no project is open, logs a message and shows a warning to the user.
        3. If the plugin is not active, activates the plugin and initializes the dock widget if it is not already created.
        4. Adds the dock widget to the QGIS interface and displays it.

        Returns:
            None
        """

        if not QgsProject.instance().fileName():
            #log_msg(logFile, "–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É. –ü–ª–∞–≥—ñ–Ω –Ω–µ –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ.")
            self.iface.messageBar().pushMessage(
                "XML-UA",
                "–°–ø–æ—á–∞—Ç–∫—É —Ç—Ä–µ–±–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–æ–µ–∫—Ç.",
                level=Qgis.Warning
            )
            return
        
        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–∂–µ—Ç–∞ –±–µ–∑ –ø–æ–∫–∞–∑—É ---
        # –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç —ñ—Å–Ω—É—î, –∞–ª–µ –Ω–µ —Ä–æ–±–∏–º–æ –π–æ–≥–æ –≤–∏–¥–∏–º–∏–º.
        # –í–∏–¥–∏–º—ñ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –º–µ—Ç–æ–¥–æ–º show_dockwidget (toggle).
        if self.dockwidget is None:
            # #log_msg(logFile, "–î–æ–∫-–≤—ñ–¥–∂–µ—Ç –Ω–µ —ñ—Å–Ω—É—î. –°—Ç–≤–æ—Ä—é—î–º–æ –π–æ–≥–æ —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ.")
            self.dockwidget = xml_uaDockWidget(parent=self.iface.mainWindow(), iface=self.iface, plugin=self)
            self.dockwidget.closingPlugin.connect(self.onClosePlugin)
            self.iface.addDockWidget(Qt.LeftDockWidgetArea, self.dockwidget)
            self.dockwidget.hide() # –Ø–≤–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
        # --- –ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω ---
    def on_save_tool(self):
        #log_msg(logFile)
        if self.dockwidget is None:
            #log_msg(logFile, "Error: dockwidget is None")
            QMessageBox.warning(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞", "–î–æ–∫ –≤—ñ–¥–∂–µ—Ç –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ.")
            return
        self.dockwidget.process_action_save()
        return
    def on_save_as_template_tool(self):
        #log_msg(logFile)
        if self.dockwidget is None:
            #log_msg(logFile, "Error: dockwidget is None")
            QMessageBox.warning(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞", "–î–æ–∫ –≤—ñ–¥–∂–µ—Ç –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ.")
            return
        self.dockwidget.process_action_save_as_template()
        return
    
    
    def on_check_tool(self):
        #log_msg(logFile)
        self.dockwidget.process_action_check()
        return
    
    
    def on_open_tool(self): 
        # –û–±—Ä–æ–±–∫–∞ –¥—ñ—ó "–í—ñ–¥–∫—Ä–∏—Ç–∏ XML"
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø—Ä–æ–µ–∫—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
        
        if not QgsProject.instance().fileName():
            self.iface.messageBar().pushMessage(
                "XML-UA",
                "–°–ø–æ—á–∞—Ç–∫—É —Ç—Ä–µ–±–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–æ–µ–∫—Ç.",
                level=Qgis.Warning
            )
            return

        # 
        self.run()

        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –í—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–∞–π–ª—É –±–µ–∑ –ø–æ–∫–∞–∑—É –≤—ñ–¥–∂–µ—Ç–∞ ---
        # –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ –≤—ñ–¥–∂–µ—Ç —ñ—Å–Ω—É—î, —ñ –≤–∏–∫–ª–∏–∫–∞—î–º–æ –ª–æ–≥—ñ–∫—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–∞–π–ª—É.
        if self.dockwidget:
            self.dockwidget.process_action_open()
        else:
            #log_msg(logFile, "–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: dockwidget –Ω–µ –±—É–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º on_open_tool.")
            pass
        # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–∏–≥–Ω–∞–ª–∏ –¥–ª—è –≤—Å—ñ—Ö —à–∞—Ä—ñ–≤
        # self.connect_layer_signals()
    
    def on_clear_tool(self):
        """–û–±—Ä–æ–±–ª—è—î –¥—ñ—é "–ó–∞–∫—Ä–∏—Ç–∏", –∑–∞–∫—Ä–∏–≤–∞—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π XML-—Ñ–∞–π–ª."""
        if self.dockwidget and self.dockwidget.current_xml:
            #log_msg(logFile, f"–ó–∞–∫—Ä–∏—Ç—Ç—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª—É: {self.dockwidget.current_xml.path}")
            self.dockwidget.process_action_close_xml(self.dockwidget.current_xml)
        else:
            #log_msg(logFile, "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∞–π–ª—É –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è.")
            QMessageBox.information(self.iface.mainWindow(), "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∞–π–ª—É –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è.")


    def clear_widget_data(self): 

        """Clears data from the dock widget."""
        if self.dockwidget is None:
            return  # Nothing to clear if the dockwidget doesn't exist

        # log_msg(logFile)

        # root = QgsProject.instance().layerTreeRoot()
        # if self.xml_layers:  # Check if xml_layers is not None
        #     group = root.findGroup(self.xml_layers.group_name)
        #     if group:
        #         root.removeChildNode(group)

        # Close all tabs except specified ones
        tabs_to_keep = ["–°—Ç—Ä—É–∫—Ç—É—Ä–∞", "–†–µ–∫–≤—ñ–∑–∏—Ç–∏", "–î—ñ–ª—è–Ω–∫–∞"]
        for i in range(self.dockwidget.tabWidget.count() -1, -1, -1): # –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –ø–æ—Ä—è–¥–æ–∫!
            tab_name = self.dockwidget.tabWidget.tabText(i)
            if tab_name not in tabs_to_keep:
                # self.dockwidget.tabWidget.removeTab(i)
                if self.dockwidget.tabWidget.count() > 0:
                    #QMessageBox.warning(self.iface.mainWindow(), "clear_widget_data", f"–≤–∏–¥–∞–ª—è—î–º–æ —Ç–∞–± ‚Ññ{i} {tab_name}")
                    self.dockwidget.tabWidget.removeTab(i)

        self.dockwidget.closed_tabs = []

        # Clear data in TreeView and TableViews (if they exist)
        try:
            tree_model = self.dockwidget.treeViewXML.model
            meta_model = self.dockwidget.tableViewMetadata.model()
            parcel_model = self.dockwidget.tableViewParcel.model()
            #set headers after clearing
            for model in [tree_model, meta_model, parcel_model]:
                if model.rowCount() > 0:
                    model.removeRows(0, model.rowCount())
                model.setHorizontalHeaderLabels(["–ï–ª–µ–º–µ–Ω—Ç", "–ó–Ω–∞—á–µ–Ω–Ω—è"])

        except AttributeError:
            #log_msg(logFile, f"AttributeError: {AttributeError}")
            pass # Handle the case where the dockwidget might not be fully initialized or if some views are missing.

        self.dockwidget.setWindowTitle("XML-—Ñ–∞–π–ª –æ–±–º—ñ–Ω—É –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é")
        self.dockwidget.xml_file_name = ""
    def remove_temporary_layers(self):
        """
            Clears all temporary layers ("memory") and 
            empty groups (non-recursively) from the QGIS project.

            Reference: on_clear_tool
        """
        # –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏ –ø—Ä–æ–µ–∫—Ç –≤—ñ–¥ —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —à–∞—Ä—ñ–≤

        # log_calls(logFile, "–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç—É...")
        project = QgsProject.instance()
        root = project.layerTreeRoot()
        # 1. Remove temporary layers
        layers_to_remove = []
        for layer_id, layer in project.mapLayers().items():
            if layer.dataProvider().name() == 'memory':
                layers_to_remove.append(layer_id)
        for layer_id in layers_to_remove:
            project.removeMapLayer(layer_id)


        def remove_empty_groups(group):
            """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤–∏–¥–∞–ª—è—î –ø–æ—Ä–æ–∂–Ω—ñ –≥—Ä—É–ø–∏ –∑ –¥–µ—Ä–µ–≤–∞ —à–∞—Ä—ñ–≤."""
            groups_to_remove = []
            for child in group.children():
                if isinstance(child, QgsLayerTreeGroup):
                    remove_empty_groups(child)  # –†–µ–∫—É—Ä—Å–∏–≤–Ω–∏–π –≤–∏–∫–ª–∏–∫ –¥–ª—è –¥–æ—á—ñ—Ä–Ω—ñ—Ö –≥—Ä—É–ø
                    if len(child.children()) == 0:
                        groups_to_remove.append(child)
            for group_to_remove in groups_to_remove:
                # #log_msg(logFile, f"–í–∏–¥–∞–ª–µ–Ω–æ –ø–æ—Ä–æ–∂–Ω—é –≥—Ä—É–ø—É: {group_to_remove.name()}")
                group.removeChildNode(group_to_remove)
        # –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö –≥—Ä—É–ø
        remove_empty_groups(root)


    def show_dockwidget(self):
        """
        –ö–µ—Ä—É—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º —Ç–∞ –≤–∏–¥–∏–º—ñ—Å—Ç—é –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç–∞.

        –¶–µ–π –º–µ—Ç–æ–¥ –ø—Ä–∞—Ü—é—î —è–∫ –ø–µ—Ä–µ–º–∏–∫–∞—á (toggle).
        - –Ø–∫—â–æ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç –Ω–µ —ñ—Å–Ω—É—î, –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —ñ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è.
        - –Ø–∫—â–æ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç —ñ—Å–Ω—É—î, –∞–ª–µ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π, –≤—ñ–Ω –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è.
        - –Ø–∫—â–æ –¥–æ–∫-–≤—ñ–¥–∂–µ—Ç —ñ—Å–Ω—É—î —ñ –≤–∏–¥–∏–º–∏–π, –≤—ñ–Ω –ø—Ä–∏—Ö–æ–≤—É—î—Ç—å—Å—è.

        –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è:
        - `tools_button.clicked`: –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —ñ–∫–æ–Ω–∫—É –ø–ª–∞–≥—ñ–Ω–∞ –Ω–∞ –ø–∞–Ω–µ–ª—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤.
        """
        # –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —É –Ω–∞—Å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–∂–µ—Ç
        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –ù–∞–¥—ñ–π–Ω–∏–π –ø–æ—à—É–∫ –≤—ñ–¥–∂–µ—Ç–∞ ---
        # –ó–∞–≤–∂–¥–∏ —à—É–∫–∞—î–º–æ –≤—ñ–¥–∂–µ—Ç –≤ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è self.dockwidget
        # –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–º –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–ª–∞–≥—ñ–Ω–∞.
        found_dockwidget = self.iface.mainWindow().findChild(xml_uaDockWidget, "")
        if self.dockwidget is None:
            # –Ø–∫—â–æ –≤—ñ–¥–∂–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä
            ##log_msg(logFile, "–î–æ–∫-–≤—ñ–¥–∂–µ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π.")
            self.dockwidget = xml_uaDockWidget(parent=self.iface.mainWindow(), iface=self.iface, plugin=self)
            self.dockwidget.closingPlugin.connect(self.onClosePlugin)
            self.iface.addDockWidget(Qt.LeftDockWidgetArea, self.dockwidget)
            self.dockwidget.hide() # –ó–∞–≤–∂–¥–∏ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
        # --- –ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω ---

        # --- –ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω: –õ–æ–≥—ñ–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç—ñ –≤—ñ–¥–∂–µ—Ç–∞ ---
        # –ü–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–∂–µ—Ç, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –≤—ñ–¥–∫—Ä–∏—Ç—ñ —Ñ–∞–π–ª–∏.
        if self.dockwidget.opened_xmls:
            if self.dockwidget.isVisible():
                self.dockwidget.hide()
            else:
                self.dockwidget.show()
                self.dockwidget.raise_()
        else:
            # –Ø–∫—â–æ —Ñ–∞–π–ª—ñ–≤ –Ω–µ–º–∞—î, –≤—ñ–¥–∂–µ—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–º, —ñ –º–∏ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.
            self.dockwidget.hide()
            self.iface.messageBar().pushMessage("–Ü–Ω—Ñ–æ", "–í—ñ–¥–∫—Ä–∏–π—Ç–µ XML-—Ñ–∞–π–ª, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –π–æ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.", level=Qgis.Info, duration=4)
        # --- –ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω ---
    def initGui(self):
        """–°—Ç–≤–æ—Ä—é—î –º–µ–Ω—é —Ç–∞ –ø–∞–Ω–µ–ª—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É QGIS."""
        self.create_toolbar_and_menu()
        
        # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–∏–≥–Ω–∞–ª–∏ —Ç—É—Ç, –æ—Å–∫—ñ–ª—å–∫–∏ initGui –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ QGIS
        try:
            QgsProject.instance().layersAdded.disconnect(self.on_layers_added)
        except TypeError:
            pass # –Ü–≥–Ω–æ—Ä—É—î–º–æ, —è–∫—â–æ –Ω–µ –±—É–ª–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
        QgsProject.instance().layersAdded.connect(self.on_layers_added)

        # –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–µ –º–µ–Ω—é –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏
        from .map_canvas_context import setup_map_canvas_context
        self.disconnect_map_canvas_context() # –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥'—î–¥–Ω—É—î–º–æ —Å—Ç–∞—Ä–µ, —è–∫—â–æ —î
        self.map_canvas_context_handler = setup_map_canvas_context(self.iface, self)

    def reload_map_canvas_context(self):
        """–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –æ–±—Ä–æ–±–Ω–∏–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏."""
        #log_msg(logFile, "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–ª–æ—Ç–Ω–∞ –∫–∞—Ä—Ç–∏.")
        from .map_canvas_context import setup_map_canvas_context
        self.disconnect_map_canvas_context()
        self.map_canvas_context_handler = setup_map_canvas_context(self.iface, self)

    def connect_picket_layer_signals(self):
        """
        –ü—ñ–¥–∫–ª—é—á–∞—î —Å–∏–≥–Ω–∞–ª editingStopped –¥–æ –≤—Å—ñ—Ö —ñ—Å–Ω—É—é—á–∏—Ö —à–∞—Ä—ñ–≤ '–í—É–∑–ª–∏' –≤ –ø—Ä–æ–µ–∫—Ç—ñ.
        –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ dockwidget –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ.
        """
        if not self.dockwidget:
            return

        project = QgsProject.instance()
        for layer_id, layer in project.mapLayers().items():
            if layer.name() == "–í—É–∑–ª–∏":
                # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–∏–≥–Ω–∞–ª —â–µ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è
                layer.editingStopped.connect(lambda l=layer: self.dockwidget.on_picket_layer_editing_stopped(l))
                #log_msg(logFile, f"–í—ñ–¥–∫–ª–∞–¥–µ–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ editingStopped –¥–ª—è —ñ—Å–Ω—É—é—á–æ–≥–æ —à–∞—Ä—É '{layer.name()}'")
        """–°—Ç–≤–æ—Ä—é—î –º–µ–Ω—é —Ç–∞ –ø–∞–Ω–µ–ª—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É QGIS."""
        self.create_toolbar_and_menu()

    def create_menu(self):
        """–°—Ç–≤–æ—Ä—é—î –º–µ–Ω—é –ø–ª–∞–≥—ñ–Ω–∞."""
        # –¶–µ–π –º–µ—Ç–æ–¥ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –¥–ª—è –º–æ–∂–ª–∏–≤–æ–≥–æ –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è
        pass


    def create_toolbar_and_menu(self):

        # –®—É–∫–∞—î–º–æ —Ç—É–ª–±–∞—Ä –∑ —ñ–º'—è–º "xml_ua" —Ç–∞ –∫–ª–∞—Å–æ–º "QToolBar"
        existing_toolbar = self.iface.mainWindow().findChild(QToolBar, "xml_ua")

        if existing_toolbar:
            ##log_msg(logFile, f"–¢—É–ª–±–∞—Ä '{existing_toolbar.objectName()}' –≤–∂–µ —ñ—Å–Ω—É—î. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ.")
            self.toolbar = existing_toolbar  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∑–Ω–∞–π–¥–µ–Ω–∏–π —Ç—É–ª–±–∞—Ä
        else:
            ##log_msg(logFile, f"–¢—É–ª–±–∞—Ä 'xml_ua' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π.")
            self.toolbar = self.iface.addToolBar(u'xml_ua') # –ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ —Å—é–¥–∏
            self.toolbar.setObjectName(u'xml_ua') # –Ü —Å—é–¥–∏

        # –¢–µ–ø–µ—Ä –º–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ self.toolbar —ñ—Å–Ω—É—î (–Ω–æ–≤–∏–π –∞–±–æ –≤–∂–µ —ñ—Å–Ω—É—é—á–∏–π)
        # –î–∞–ª—ñ —Å—Ç–≤–æ—Ä—é—î–º–æ –º–µ–Ω—é —ñ –∫–Ω–æ–ø–∫–∏, —Ç–∞ –¥–æ–¥–∞—î–º–æ —ó—Ö –Ω–∞ —Ç—É–ª–±–∞—Ä

        icon_path = ':/plugins/xml_ua/icon.png'
        self.tools_menu = QMenu(self.iface.mainWindow())

        self.action_new_tool = QAction("–ù–æ–≤–∏–π XML", self.iface.mainWindow())
        # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É "–ù–æ–≤–∏–π" –∑ QGIS
        new_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_FileIcon)
        self.action_new_tool.setIcon(new_icon)


        self.action_open_tool = QAction("–í—ñ–¥–∫—Ä–∏—Ç–∏", self.iface.mainWindow())

        # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É "–í—ñ–¥–∫—Ä–∏—Ç–∏" –∑ QGIS
        open_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_DirOpenIcon)
        self.action_open_tool.setIcon(open_icon)

        self.action_save_tool = QAction("–ó–±–µ—Ä–µ–≥—Ç–∏", self.iface.mainWindow())
        # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É "–ó–±–µ—Ä–µ–≥—Ç–∏" –∑ QGIS
        save_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_DialogSaveButton)
        self.action_save_tool.setIcon(save_icon)

        self.action_save_as_template_tool = QAction("–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —à–∞–±–ª–æ–Ω...", self.iface.mainWindow())
        # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É "–ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫..." –∑ QGIS
        save_as_icon = QIcon(QgsApplication.iconPath("mActionFileSaveAs.svg"))
        self.action_save_as_template_tool.setIcon(save_as_icon)

        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
        self.action_save_tool.setEnabled(False)
        self.action_save_as_template_tool.setEnabled(False)

        self.action_check_tool = QAction("–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏", self.iface.mainWindow())
        # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É "–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏" (–≥–∞–ª–æ—á–∫–∞) –∑ QGIS
        check_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_DialogApplyButton)
        self.action_check_tool.setIcon(check_icon)
        self.action_clear_data = QAction("–ó–∞–∫—Ä–∏—Ç–∏", self.iface.mainWindow())
        # –Ü–∫–æ–Ω–∫–∞ "–≤–∏–¥–∞–ª–∏—Ç–∏ —à–∞—Ä" (—á–µ—Ä–≤–æ–Ω–∏–π –º—ñ–Ω—É—Å), —è–∫ –ø—Ä–æ—Å–∏–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
        close_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_DialogCloseButton)
        self.action_clear_data.setIcon(close_icon)

        # üìå –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –∫–æ–ø—ñ—ó
        self.action_restore_backup = QAction("–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó...", self.iface.mainWindow())
        restore_icon = self.iface.mainWindow().style().standardIcon(QStyle.SP_BrowserReload)
        self.action_restore_backup.setToolTip("–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π —Ñ–∞–π–ª –∑ –π–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó, —Å—Ç–≤–æ—Ä–µ–Ω–æ—ó –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ")
        self.action_restore_backup.setIcon(restore_icon)

        self.action_check_tool.setEnabled(False)
        self.action_clear_data.setEnabled(False)
        self.action_restore_backup.setEnabled(False)

        self.tools_menu.addActions([self.action_new_tool, self.action_open_tool, self.action_save_tool, self.action_save_as_template_tool, self.action_check_tool])
        self.tools_menu.addAction(self.action_clear_data)
        self.tools_menu.addAction(self.action_restore_backup)
        #self.tools_menu.addAction(self.action_restore_tabs)

        self.tools_button = QToolButton()
        self.tools_button.setIcon(QIcon(icon_path))
        self.tools_button.setMenu(self.tools_menu)
        self.tools_button.setPopupMode(QToolButton.MenuButtonPopup)

        #self.action_restore_tabs.setEnabled(False)
        self.dockwidget = None

        connector.connect(self.action_new_tool, "triggered", self.on_new_tool)
        connector.connect(self.action_open_tool, "triggered", self.on_open_tool)
        connector.connect(self.action_save_tool, "triggered", self.on_save_tool)
        connector.connect(self.action_save_as_template_tool, "triggered", self.on_save_as_template_tool)
        connector.connect(self.action_check_tool, "triggered", self.on_check_tool)
        connector.connect(self.action_clear_data, "triggered", self.on_clear_tool)
        connector.connect(self.action_restore_backup, "triggered", self.restore_from_copy)
        
        self.tools_button.setObjectName("xml_ua_tools_button")
        self.toolbar.addWidget(self.tools_button)

        connector.connect(self.tools_button, "clicked", self.show_dockwidget)

    def on_layers_added(self, layers):
        """
        –û–±—Ä–æ–±–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª—É –ø—Ä–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞—Ä—ñ–≤ –¥–æ –ø—Ä–æ–µ–∫—Ç—É.  –ü—ñ–¥–∫–ª—é—á–∞—î —Å–∏–≥–Ω–∞–ª–∏ –ª–∏—à–µ –¥–æ –Ω–æ–≤–∏—Ö —à–∞—Ä—ñ–≤.
        """
        for layer in layers:
            if isinstance(layer, QgsVectorLayer):
                # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ lambda –¥–ª—è –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —à–∞—Ä—É `layer`
                layer.featureAdded.connect(lambda fid, l=layer: self.on_feature_added(l, fid))
                layer.featureDeleted.connect(lambda fid, l=layer: self.on_feature_removed(l, fid))
                layer.committedFeaturesRemoved.connect(lambda l, fids: self.on_committed_features_removed(l, fids))
                layer.geometryChanged.connect(lambda fid, geom, l=layer: self.on_geometry_changed(l, fid, geom))

                # –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ editingStopped –¥–ª—è —à–∞—Ä—É "–í—É–∑–ª–∏"
                if layer.name() == "–í—É–∑–ª–∏" and self.dockwidget:
                    try:
                        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ lambda –¥–ª—è –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —à–∞—Ä—É `l`
                        layer.editingStopped.connect(lambda l=layer: self.dockwidget.on_picket_layer_editing_stopped(l))
                    except Exception as e:
                        log_msg(logFile, f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ editingStopped –¥–ª—è —à–∞—Ä—É '{layer.name()}': {e}")


    def restore_from_copy(self):
        """–í—ñ–¥–Ω–æ–≤–ª—é—î –∞–∫—Ç–∏–≤–Ω–∏–π XML-—Ñ–∞–π–ª –∑ –π–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó."""
        #log_msg(logFile, "–ó–∞–ø—É—â–µ–Ω–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –∫–æ–ø—ñ—ó.")

        if not self.dockwidget or not self.dockwidget.current_xml:
            QMessageBox.warning(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞", "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∞–π–ª—É –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.")
            return
        
        active_xml = self.dockwidget.current_xml
        original_path = active_xml.path
        backup_path = active_xml.backup_path

        if not backup_path or not os.path.exists(backup_path):
            QMessageBox.warning(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞", f"–†–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ —à–ª—è—Ö–æ–º:\n{backup_path}")
            return

        if not backup_path or not os.path.exists(backup_path):
            QMessageBox.warning(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞", f"–†–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ —à–ª—è—Ö–æ–º:\n{backup_path}")
            return

        reply = QMessageBox.question(self.iface.mainWindow(), "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è",
                                     f"–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ñ–∞–π–ª\n'{os.path.basename(original_path)}'\n–∑ –π–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó? –£—Å—ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏ –±—É–¥–µ –≤—Ç—Ä–∞—á–µ–Ω–æ.",
                                     QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
        
        if reply == QMessageBox.No:
            #log_msg(logFile, "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∫–∞—Å–æ–≤–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º.")
            return

        try:
            # 1. –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –≤–∫–ª–∞–¥–∫—É —Ç–∞ –≥—Ä—É–ø—É –ø—Ä–∏–º—É—Å–æ–≤–æ
            self.dockwidget.process_action_close_xml(active_xml, force_close=True)
            # 2. –ó–∞–º—ñ–Ω—é—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª –∫–æ–ø—ñ—î—é
            shutil.copy2(backup_path, original_path)
            #log_msg(logFile, f"–§–∞–π–ª '{original_path}' –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ '{backup_path}'.")
            # 3. –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–∏–π —Ñ–∞–π–ª
            self.dockwidget.open_xml_file(original_path)
            self.iface.messageBar().pushMessage("–î–∏—Å–∫:", f"–§–∞–π–ª '{os.path.basename(original_path)}' —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.", level=Qgis.Success, duration=5)
        except Exception as e:
            #log_msg(logFile, f"–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è: {e}")
            QMessageBox.critical(self.iface.mainWindow(), "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è", f"–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞: {e}")

    def on_new_tool(self):

        """–û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ XML-—Ñ–∞–π–ª—É."""
        #log_msg(logFile)
        # –°—Ç–≤–æ—Ä—é—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É
        creator = NewXmlCreator(self.iface, self)
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
        creator.execute()
